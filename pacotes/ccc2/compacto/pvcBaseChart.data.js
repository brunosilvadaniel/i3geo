pvc.BaseChart.add({dataEngine:null,data:null,_partData:null,_visibleDataCache:null,resultset:[],metadata:[],_constructData:function(options){var parent=this.parent;if(parent){this.dataEngine=this.data=options.data||def.fail.argumentRequired('options.data')}},_checkNoDataI:function(){if(!this.parent){if(!this.allowNoData&&this.resultset.length===0){throw new NoDataException()}}},_checkNoDataII:function(){if(!this.parent){if(!this.allowNoData&&(!this.data||!this.data.count())){throw new NoDataException()}}},_initData:function(keyArgs){if(!this.parent){var data=this.data;if(!data||def.get(keyArgs,'reloadData',true)){this._onLoadData()}else{data.clearVirtuals();data.disposeChildren()}}delete this._partData;delete this._visibleDataCache;if(pvc.debug>=3){this._log(this.data.getInfo())}},_onLoadData:function(){var data=this.data;var options=this.options;var dataPartDimName=this._getDataPartDimName();var complexTypeProj=this._complexTypeProj;var translOptions=this._createTranslationOptions(dataPartDimName);var translation=this._createTranslation(translOptions);if(pvc.debug>=3){translation.logSource()}if(!data){translation.configureType();if(dataPartDimName&&!complexTypeProj.isReadOrCalc(dataPartDimName)){this._addDefaultDataPartCalculation(dataPartDimName)}}this._bindVisualRolesPostI();var complexType;if(!data){complexType=new pvc.data.ComplexType();complexTypeProj.configureComplexType(complexType,translOptions)}else{complexType=data.type}this._bindVisualRolesPostII(complexType);if(pvc.debug>=10){this._log(complexType.describe())}if(pvc.debug>=3){this._logVisualRoles()}if(!data){data=this.dataEngine=this.data=new pvc.data.Data({type:complexType,labelSep:options.groupedLabelSep})}var loadKeyArgs={where:this._getLoadFilter(),isNull:this._getIsNullDatum()};var resultQuery=translation.execute(data);data.load(resultQuery,loadKeyArgs)},_createComplexTypeProject:function(){var options=this.options;var complexTypeProj=new pvc.data.ComplexTypeProject(options.dimensionGroups);var userDimsSpec=options.dimensions;for(var dimName in userDimsSpec){complexTypeProj.setDim(dimName,userDimsSpec[dimName])}var dataPartDimName=this._getDataPartDimName();if(dataPartDimName){complexTypeProj.setDim(dataPartDimName);this._addPlot2SeriesDataPartCalculation(complexTypeProj,dataPartDimName)}var calcSpecs=options.calculations;if(calcSpecs){calcSpecs.forEach(function(calcSpec){complexTypeProj.setCalc(calcSpec)})}return complexTypeProj},_getLoadFilter:function(){if(this.options.ignoreNulls){var me=this;return function(datum){var isNull=datum.isNull;if(isNull&&pvc.debug>=4){me._info("Datum excluded.")}return!isNull}}},_getIsNullDatum:function(){var measureDimNames=this.measureDimensionsNames(),M=measureDimNames.length;if(M){return function(datum){var atoms=datum.atoms;for(var i=0;i<M;i++){if(atoms[measureDimNames[i]].value!=null){return false}}return true}}},_createTranslation:function(translOptions){var TranslationClass=this._getTranslationClass(translOptions);return new TranslationClass(this,this._complexTypeProj,this.resultset,this.metadata,translOptions)},_getTranslationClass:function(translOptions){return translOptions.crosstabMode?pvc.data.CrosstabTranslationOper:pvc.data.RelationalTranslationOper},_createTranslationOptions:function(dataPartDimName){var options=this.options;var dataOptions=options.dataOptions||{};var dataSeparator=options.dataSeparator;if(dataSeparator===undefined){dataSeparator=dataOptions.separator}var dataMeasuresInColumns=options.dataMeasuresInColumns;if(dataMeasuresInColumns===undefined){dataMeasuresInColumns=dataOptions.measuresInColumns}var dataCategoriesCount=options.dataCategoriesCount;if(dataCategoriesCount===undefined){dataCategoriesCount=dataOptions.categoriesCount}var plot2=options.plot2;var valueFormat=options.valueFormat,valueFormatter;if(valueFormat&&valueFormat!==this.defaults.valueFormat){valueFormatter=function(v){return v!=null?valueFormat(v):""}}var secondAxisIdx;if(plot2&&this._allowV1SecondAxis&&(this.compatVersion()<=1)){secondAxisIdx=pvc.parseDistinctIndexArray(options.secondAxisIdx)||-1}return{compatVersion:this.compatVersion(),plot2SeriesIndexes:secondAxisIdx,seriesInRows:options.seriesInRows,crosstabMode:options.crosstabMode,isMultiValued:options.isMultiValued,dataPartDimName:dataPartDimName,dimensionGroups:options.dimensionGroups,dimensions:options.dimensions,readers:options.readers,measuresIndexes:options.measuresIndexes,multiChartIndexes:options.multiChartIndexes,separator:dataSeparator,measuresInColumns:dataMeasuresInColumns,categoriesCount:dataCategoriesCount,measuresIndex:dataOptions.measuresIndex||dataOptions.measuresIdx,measuresCount:dataOptions.measuresCount||dataOptions.numMeasures,isCategoryTimeSeries:options.timeSeries,timeSeriesFormat:options.timeSeriesFormat,valueNumberFormatter:valueFormatter}},_addPlot2SeriesDataPartCalculation:function(complexTypeProj,dataPartDimName){if(this.compatVersion()<=1){return}var options=this.options;var serRole=this._serRole;var plot2Series=(serRole!=null)&&options.plot2&&options.plot2Series&&def.array.as(options.plot2Series);if(!plot2Series||!plot2Series.length){return}var inited=false;var plot2SeriesSet=def.query(plot2Series).uniqueIndex();var dimNames,dataPartDim,part1Atom,part2Atom;complexTypeProj.setCalc({names:dataPartDimName,calculation:function(datum,atoms){if(!inited){if(serRole.isBound()){dimNames=serRole.grouping.dimensionNames();dataPartDim=datum.owner.dimensions(dataPartDimName)}inited=true}if(dataPartDim){var seriesKey=pvc.data.Complex.values(datum,dimNames).join(',');atoms[dataPartDimName]=def.hasOwnProp.call(plot2SeriesSet,seriesKey)?(part2Atom||(part2Atom=dataPartDim.intern("1"))):(part1Atom||(part1Atom=dataPartDim.intern("0")))}}})},_addDefaultDataPartCalculation:function(dataPartDimName){var dataPartDim,part1Atom;this._complexTypeProj.setCalc({names:dataPartDimName,calculation:function(datum,atoms){if(!dataPartDim){dataPartDim=datum.owner.dimensions(dataPartDimName)}atoms[dataPartDimName]=part1Atom||(part1Atom=dataPartDim.intern("0"))}})},partData:function(dataPartValues){if(!this._partData){if(!this._dataPartRole||!this._dataPartRole.grouping){return this._partData=this.data}this._partData=this.data.flattenBy(this._dataPartRole)}if(!dataPartValues||!this._dataPartRole||!this._dataPartRole.grouping){return this._partData}var dataPartDimName=this._dataPartRole.firstDimensionName();if(def.array.is(dataPartValues)){if(dataPartValues.length>1){return this._partData.where([def.set({},dataPartDimName,dataPartValues)])}dataPartValues=dataPartValues[0]}var child=this._partData._childrenByKey[dataPartValues+''];if(!child){var dataPartCell={v:dataPartValues};if(dataPartValues==='trend'){var firstTrendAtom=this._firstTrendAtomProto;if(firstTrendAtom){dataPartCell.f=firstTrendAtom.f}}child=new pvc.data.Data({parent:this._partData,atoms:def.set({},dataPartDimName,dataPartCell),dimNames:[dataPartDimName],datums:[]})}return child},visibleData:function(dataPartValue,keyArgs){var ignoreNulls=def.get(keyArgs,'ignoreNulls',true);if(ignoreNulls&&this.options.ignoreNulls){ignoreNulls=false}keyArgs=keyArgs?Object.create(keyArgs):{};keyArgs.ignoreNulls=ignoreNulls;var key=ignoreNulls+'|'+dataPartValue,data=def.getOwn(this._visibleDataCache,key);if(!data){data=this._createVisibleData(dataPartValue,keyArgs);if(data){(this._visibleDataCache||(this._visibleDataCache={}))[key]=data}}return data},_createVisibleData:function(dataPartValue,keyArgs){var partData=this.partData(dataPartValue);if(!partData){return null}var ignoreNulls=def.get(keyArgs,'ignoreNulls');return this._serRole&&this._serRole.grouping?partData.flattenBy(this._serRole,{visible:true,isNull:ignoreNulls?false:null}):partData},_generateTrends:function(){if(this._dataPartRole){def.query(def.own(this.axes)).selectMany(function(axis){return axis.dataCells}).where(function(dataCell){return!!dataCell.trend}).distinct(function(dataCell){return dataCell.role.name+'|'+(dataCell.dataPartValue||'')}).each(this._generateTrendsDataCell,this)}},_interpolate:function(){def.query(def.own(this.axes)).selectMany(function(axis){return axis.dataCells}).where(function(dataCell){var nim=dataCell.nullInterpolationMode;return!!nim&&nim!=='none'}).distinct(function(dataCell){return dataCell.role.name+'|'+(dataCell.dataPartValue||'')}).each(this._interpolateDataCell,this)},_interpolateDataCell:function(dataCell){},_generateTrendsDataCell:function(dataCell){},setData:function(data,options){this.setResultset(data.resultset);this.setMetadata(data.metadata);$.extend(this.options,options);return this},setResultset:function(resultset){!this.parent||def.fail.operationInvalid("Can only set resultset on root chart.");this.resultset=resultset;if(!resultset.length){this._log("Warning: Resultset is empty")}return this},setMetadata:function(metadata){!this.parent||def.fail.operationInvalid("Can only set resultset on root chart.");this.metadata=metadata;if(!metadata.length){this._log("Warning: Metadata is empty")}return this}});