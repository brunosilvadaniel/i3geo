def.type('pvc.CartesianAbstract',pvc.BaseChart).init(function(options){this.axesPanels={};this.base(options)}).add({_gridDockPanel:null,axesPanels:null,yAxisPanel:null,xAxisPanel:null,secondXAxisPanel:null,secondYAxisPanel:null,yScale:null,xScale:null,_getSeriesRoleSpec:function(){return{isRequired:true,defaultDimension:'series*',autoCreateDimension:true,requireIsDiscrete:true}},_getColorRoleSpec:function(){return{isRequired:true,defaultDimension:'color*',defaultSourceRole:'series',requireIsDiscrete:true}},_collectPlotAxesDataCells:function(plot,dataCellsByAxisTypeThenIndex){this.base(plot,dataCellsByAxisTypeThenIndex);if(plot.option.isDefined('BaseAxis')){var baseDataCellsByAxisIndex=def.array.lazy(dataCellsByAxisTypeThenIndex,'base');def.array.lazy(baseDataCellsByAxisIndex,plot.option('BaseAxis')-1).push({plot:plot,role:this.visualRoles(plot.option('BaseRole')),dataPartValue:plot.option('DataPart')})}if(plot.option.isDefined('OrthoAxis')){var trend=plot.option('Trend');var isStacked=plot.option.isDefined('Stacked')?plot.option('Stacked'):undefined;var orthoDataCellsByAxisIndex=def.array.lazy(dataCellsByAxisTypeThenIndex,'ortho');var orthoRoleNames=def.array.to(plot.option('OrthoRole'));var dataCellBase={dataPartValue:plot.option('DataPart'),isStacked:isStacked,trend:trend,nullInterpolationMode:plot.option('NullInterpolationMode')};var orthoDataCells=def.array.lazy(orthoDataCellsByAxisIndex,plot.option('OrthoAxis')-1);orthoRoleNames.forEach(function(orthoRoleName){var dataCell=Object.create(dataCellBase);dataCell.role=this.visualRoles(orthoRoleName);orthoDataCells.push(dataCell)},this)}},_addAxis:function(axis){this.base(axis);switch(axis.type){case'base':case'ortho':this.axes[axis.orientedId]=axis;if(axis.v1SecondOrientedId){this.axes[axis.v1SecondOrientedId]=axis}break}return this},_generateTrendsDataCell:function(dataCell){var trend=dataCell.trend;if(trend){var trendInfo=pvc.trends.get(trend.type);var newDatums=[];this._generateTrendsDataCellCore(newDatums,dataCell,trendInfo);if(newDatums.length){this.data.owner.add(newDatums)}}},_generateTrendsDataCellCore:function(dataCell,trendInfo){},_setAxesScales:function(hasMultiRole){this.base(hasMultiRole);if(!hasMultiRole||this.parent){['base','ortho'].forEach(function(type){var axisOfType=this.axesByType[type];if(axisOfType){axisOfType.forEach(this._createAxisScale,this)}},this)}},_createAxisScale:function(axis){var isOrtho=axis.type==='ortho';var isCart=isOrtho||axis.type==='base';var scale=this._createScaleByAxis(axis);if(scale.isNull&&pvc.debug>=3){this._log(def.format("{0} scale for axis '{1}'- no data",[axis.scaleType,axis.id]))}scale=axis.setScale(scale).scale;if(isCart){if(isOrtho&&axis.index===1){this.secondScale=scale}else if(!axis.index){this[axis.orientation+'Scale']=scale}}return scale},_createScaleByAxis:function(axis){var createScale=this['_create'+def.firstUpperCase(axis.scaleType)+'ScaleByAxis'];return createScale.call(this,axis)},_preRenderContent:function(contentOptions){this._createFocusWindow();this._gridDockPanel=new pvc.CartesianGridDockingPanel(this,this.basePanel,{margins:contentOptions.margins,paddings:contentOptions.paddings});['base','ortho'].forEach(function(type){var typeAxes=this.axesByType[type];if(typeAxes){def.query(typeAxes).reverse().each(function(axis){this._createAxisPanel(axis)},this)}},this);this._createPlotPanels(this._gridDockPanel,{clickAction:contentOptions.clickAction,doubleClickAction:contentOptions.doubleClickAction})},_createFocusWindow:function(){if(this._canSelectWithFocusWindow()){var fwData;var fw=this.focusWindow;if(fw){fwData=fw._exportData()}fw=this.focusWindow=new pvc.visual.CartesianFocusWindow(this);if(fwData){fw._importData(fwData)}fw._initFromOptions()}else if(this.focusWindow){delete this.focusWindow}},_createAxisPanel:function(axis){if(axis.option('Visible')){var titlePanel;var title=axis.option('Title');if(!def.empty(title)){titlePanel=new pvc.AxisTitlePanel(this,this._gridDockPanel,axis,{title:title,font:axis.option('TitleFont')||axis.option('Font'),anchor:axis.option('Position'),align:axis.option('TitleAlign'),margins:axis.option('TitleMargins'),paddings:axis.option('TitlePaddings'),titleSize:axis.option('TitleSize'),titleSizeMax:axis.option('TitleSizeMax')})}var panel=new pvc.AxisPanel(this,this._gridDockPanel,axis,{anchor:axis.option('Position'),size:axis.option('Size'),sizeMax:axis.option('SizeMax'),clickAction:axis.option('ClickAction'),doubleClickAction:axis.option('DoubleClickAction'),useCompositeAxis:axis.option('Composite'),font:axis.option('Font'),labelSpacingMin:axis.option('LabelSpacingMin'),tickExponentMin:axis.option('TickExponentMin'),tickExponentMax:axis.option('TickExponentMax'),grid:axis.option('Grid'),gridCrossesMargin:axis.option('GridCrossesMargin'),ruleCrossesMargin:axis.option('RuleCrossesMargin'),zeroLine:axis.option('ZeroLine'),domainRoundMode:axis.option('DomainRoundMode'),desiredTickCount:axis.option('DesiredTickCount'),showTicks:axis.option('Ticks'),showMinorTicks:axis.option('MinorTicks')});if(titlePanel){panel.titlePanel=titlePanel}this.axesPanels[axis.id]=panel;this.axesPanels[axis.orientedId]=panel;if(axis.index<=1&&axis.v1SecondOrientedId){this[axis.v1SecondOrientedId+'AxisPanel']=panel}return panel}},_createDiscreteScaleByAxis:function(axis){var dataPartValues=axis.dataCells.map(function(dataCell){return dataCell.dataPartValue});var baseData=this.visibleData(dataPartValues,{ignoreNulls:false});var data=baseData&&baseData.flattenBy(axis.role);var scale=new pv.Scale.ordinal();if(!data||!data.count()){scale.isNull=true}else{var values=data.children().select(function(child){return def.nullyTo(child.value,"")}).array();scale.domain(values)}return scale},_createTimeSeriesScaleByAxis:function(axis){var extent=this._getContinuousVisibleExtent(axis);var scale=new pv.Scale.linear();if(!extent){scale.isNull=true}else{var dMin=extent.min;var dMax=extent.max;if((dMax-dMin)===0){dMax=new Date(dMax.getTime()+3600000)}scale.domain(dMin,dMax);scale.minLocked=extent.minLocked;scale.maxLocked=extent.maxLocked}return scale},_createNumericScaleByAxis:function(axis){var extent=this._getContinuousVisibleExtentConstrained(axis);var scale=new pv.Scale.linear();if(!extent){scale.isNull=true}else{var tmp;var dMin=extent.min;var dMax=extent.max;if(dMin>dMax){tmp=dMin;dMin=dMax;dMax=tmp}var originIsZero=axis.option('OriginIsZero');if(originIsZero){if(dMin===0){extent.minLocked=true}else if(dMax===0){extent.maxLocked=true}else if((dMin*dMax)>0){if(dMin>0){if(!extent.minLocked){extent.minLocked=true;dMin=0}}else{if(!extent.maxLocked){extent.maxLocked=true;dMax=0}}}}if(dMin>dMax){tmp=dMin;dMin=dMax;dMax=tmp}if(dMax-dMin<=1e-12){if(!extent.minLocked){dMin=dMin!==0?(dMin*0.99):-0.1}if(!extent.maxLocked||extent.minLocked){dMax=dMax!==0?dMax*1.01:0.1}}scale.domain(dMin,dMax);scale.minLocked=extent.minLocked;scale.maxLocked=extent.maxLocked}return scale},_onLaidOut:function(){if(this.plotPanelList&&this.plotPanelList[0]){['base','ortho'].forEach(function(type){var axes=this.axesByType[type];if(axes){axes.forEach(this._setCartAxisScaleRange,this)}},this)}},_setCartAxisScaleRange:function(axis){var info=this.plotPanelList[0]._layoutInfo;var size=info.clientSize;var length=(axis.orientation==='x')?size.width:size.height;axis.setScaleRange(length);return axis.scale},_getAxesRoundingPaddings:function(){var axesPaddings={};var axesByType=this.axesByType;['base','ortho'].forEach(function(type){var typeAxes=axesByType[type];if(typeAxes){typeAxes.forEach(processAxis)}});return axesPaddings;function setSide(side,pct,locked){var value=axesPaddings[side];if(value==null||pct>value){axesPaddings[side]=pct;axesPaddings[side+'Locked']=locked}else if(locked){axesPaddings[side+'Locked']=locked}}function processAxis(axis){if(axis){var tickRoundPads=axis.getScaleRoundingPaddings();if(tickRoundPads){var isX=axis.orientation==='x';setSide(isX?'left':'bottom',tickRoundPads.begin,tickRoundPads.beginLocked);setSide(isX?'right':'top',tickRoundPads.end,tickRoundPads.endLocked)}}}},_warnSingleContinuousValueRole:function(valueRole){if(!valueRole.grouping.isSingleDimension){this._log("[WARNING] A linear scale can only be obtained for a single dimension role.")}if(valueRole.grouping.isDiscrete()){this._log("[WARNING] The single dimension of role '{0}' should be continuous.",[valueRole.name])}},_getContinuousVisibleExtentConstrained:function(axis,min,max){var minLocked=false;var maxLocked=false;if(min==null){min=axis.option('FixedMin');minLocked=(min!=null)}if(max==null){max=axis.option('FixedMax');maxLocked=(max!=null)}if(min==null||max==null){var baseExtent=this._getContinuousVisibleExtent(axis);if(!baseExtent){return null}if(min==null){min=baseExtent.min}if(max==null){max=baseExtent.max}}return{min:min,max:max,minLocked:minLocked,maxLocked:maxLocked}},_getContinuousVisibleExtent:function(valueAxis){var dataCells=valueAxis.dataCells;if(dataCells.length===1){return this._getContinuousVisibleCellExtent(valueAxis,dataCells[0])}return def.query(dataCells).select(function(dataCell){return this._getContinuousVisibleCellExtent(valueAxis,dataCell)},this).reduce(pvc.unionExtents,null)},_getContinuousVisibleCellExtent:function(valueAxis,valueDataCell){var valueRole=valueDataCell.role;this._warnSingleContinuousValueRole(valueRole);if(valueRole.name==='series'){throw def.error.notImplemented()}var useAbs=valueAxis.scaleUsesAbs();var data=this.visibleData(valueDataCell.dataPartValue);var extent=data&&data.dimensions(valueRole.firstDimensionName()).extent({abs:useAbs});if(extent){var minValue=extent.min.value;var maxValue=extent.max.value;return{min:(useAbs?Math.abs(minValue):minValue),max:(useAbs?Math.abs(maxValue):maxValue)}}},markEventDefaults:{strokeStyle:"#5BCBF5",lineWidth:"0.5",textStyle:"#5BCBF5",verticalOffset:10,verticalAnchor:"bottom",horizontalAnchor:"right",forceHorizontalAnchor:false,horizontalAnchorSwapLimit:80},markEvent:function(dateString,label,options){var baseScale=this.axes.base.scale;if(baseScale.type!=='timeSeries'){this._log("Attempting to mark an event on a non timeSeries chart");return this}var o=$.extend({},this.markEventDefaults,options);var d=pv.Format.date(this.options.timeSeriesFormat).parse(dateString);var dpos=baseScale(d),range=baseScale.range();if(dpos<range[0]||dpos>range[1]){this._log("Event outside the allowed range, returning");return this}var panel=this.plotPanelList[0].pvPanel;var h=this.yScale.range()[1];if(!o.forceHorizontalAnchor){var availableSize=o.horizontalAnchor=="right"?range[1]-dpos:dpos;if(availableSize<o.horizontalAnchorSwapLimit){o.horizontalAnchor=o.horizontalAnchor=="right"?"left":"right"}}var line=panel.add(pv.Line).data([0,h]).strokeStyle(o.strokeStyle).lineWidth(o.lineWidth).bottom(function(d){return d}).left(dpos);line.anchor(o.horizontalAnchor).top(o.verticalAnchor=="top"?o.verticalOffset:(h-o.verticalOffset)).add(pv.Label).text(label).textStyle(o.textStyle).visible(function(){return!this.index});return this},defaults:{panelSizeRatio:0.9,timeSeries:false,timeSeriesFormat:"%Y-%m-%d"}});