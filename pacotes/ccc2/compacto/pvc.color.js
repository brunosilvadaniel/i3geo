def.scope(function(){pvc.color={scale:colorScale,scales:colorScales};function colorScales(keyArgs){keyArgs||def.fail.argumentRequired('keyArgs');var type=keyArgs.type||def.fail.argumentRequired('keyArgs.type');switch(type){case'linear':return new pvc.color.LinearScalesBuild(keyArgs).buildMap();case'discrete':return new pvc.color.DiscreteScalesBuild(keyArgs).buildMap();case'normal':return new pvc.color.NormalScalesBuild(keyArgs).buildMap()}throw def.error.argumentInvalid('scaleType',"Unexistent scale type '{0}'.",[type])}function colorScale(keyArgs){keyArgs||def.fail.argumentRequired('keyArgs');var type=keyArgs.type||def.fail.argumentRequired('keyArgs.type');switch(type){case'linear':return new pvc.color.LinearScalesBuild(keyArgs).build();case'discrete':return new pvc.color.DiscreteScalesBuild(keyArgs).build();case'normal':return new pvc.color.NormalScalesBuild(keyArgs).build()}throw def.error.argumentInvalid('scaleType',"Unexistent scale type '{0}'.",[type])}def.type('pvc.color.ScalesBuild').init(function(keyArgs){this.keyArgs=keyArgs;this.data=keyArgs.data||def.fail.argumentRequired('keyArgs.data');this.domainDimName=keyArgs.colorDimension||def.fail.argumentRequired('keyArgs.colorDimension');this.domainDim=this.data.dimensions(this.domainDimName);var dimType=this.domainDim.type;if(!dimType.isComparable){this.domainComparer=null;pvc.log("Color value dimension should be comparable. Generated color scale may be invalid.")}else{this.domainComparer=function(a,b){return dimType.compare(a,b)}}this.nullRangeValue=keyArgs.colorNull?pv.color(keyArgs.colorNull):pv.Color.transparent;this.domainRangeCountDif=0}).add({build:function(){this.range=this._getRange();this.desiredDomainCount=this.range.length+this.domainRangeCountDif;var domain=this._getDomain();return this._createScale(domain)},buildMap:function(){this.range=this._getRange();this.desiredDomainCount=this.range.length+this.domainRangeCountDif;var createCategoryScale;if(this.keyArgs.normPerBaseCategory){createCategoryScale=function(leafData){var domain=this._ensureDomain(null,false,leafData);return this._createScale(domain)}}else{var domain=this._getDomain(),scale=this._createScale(domain);createCategoryScale=def.fun.constant(scale)}return this._createCategoryScalesMap(createCategoryScale)},_createScale:def.method({isAbstract:true}),_createCategoryScalesMap:function(createCategoryScale){return this.data.children().object({name:function(leafData){return leafData.absKey},value:createCategoryScale,context:this})},_getRange:function(){var keyArgs=this.keyArgs,range=keyArgs.colors||['red','yellow','green'];if(keyArgs.colorMin!=null&&keyArgs.colorMax!=null){range=[keyArgs.colorMin,keyArgs.colorMax]}else if(keyArgs.colorMin!=null){range.unshift(keyArgs.colorMin)}else if(keyArgs.colorMax!=null){range.push(keyArgs.colorMax)}return range.map(function(c){return pv.color(c)})},_getDataExtent:function(data){var extent=data.dimensions(this.domainDimName).extent({visible:true});if(!extent){return null}var min=extent.min.value,max=extent.max.value;if(max==min){if(max>=1){min=max-1}else{max=min+1}}return{min:min,max:max}},_getDomain:function(){var domain=this.keyArgs.colorDomain;if(domain!=null){if(this.domainComparer){domain.sort(this.domainComparer)}if(domain.length>this.desiredDomainCount){domain=domain.slice(0,this.desiredDomainCount)}}else{domain=[]}return this._ensureDomain(domain,true,this.data)},_ensureDomain:function(domain,doDomainPadding,data){var extent;if(domain&&doDomainPadding){var domainPointsMissing=this.desiredDomainCount-domain.length;if(domainPointsMissing>0){extent=this._getDataExtent(data);if(extent){switch(domainPointsMissing){case 1:if(this.domainComparer){def.array.insert(domain,extent.max,this.domainComparer)}else{domain.push(extent.max)}break;case 2:if(this.domainComparer){def.array.insert(domain,extent.min,this.domainComparer);def.array.insert(domain,extent.max,this.domainComparer)}else{domain.unshift(extent.min);domain.push(extent.max)}break;default:if(pvc.debug>=2){pvc.log("Ignoring option 'colorDomain' due to unsupported length."+def.format(" Should have '{0}', but instead has '{1}'.",[this.desiredDomainCount,domain.length]))}domain=null}}}}if(!domain){extent||(extent=this._getDataExtent(data));if(extent){var min=extent.min,max=extent.max;var step=(max-min)/(this.desiredDomainCount-1);domain=pv.range(min,max+step,step)}}return domain}});def.type('pvc.color.LinearScalesBuild',pvc.color.ScalesBuild).add({_createScale:function(domain){var scale=pv.Scale.linear();if(domain){scale.domain.apply(scale,domain)}scale.range.apply(scale,this.range);return scale}});def.type('pvc.color.DiscreteScalesBuild',pvc.color.ScalesBuild).init(function(keyArgs){this.base(keyArgs);this.domainRangeCountDif=1}).add({_createScale:function(domain){var Dl=domain.length-1,range=this.range,nullRangeValue=this.nullRangeValue,Rl=range.length-1;function scale(val){if(val==null){return nullRangeValue}for(var i=0;i<Dl;i++){if(val<=domain[i+1]){return range[i]}}return range[Rl]}def.copy(scale,pv.Scale.common);return scale}})});