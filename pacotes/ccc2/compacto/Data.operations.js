pvc.data.Data.add({load:function(atomz,keyArgs){data_assertIsOwner.call(this);var whereFun=def.get(keyArgs,'where');var isNullFun=def.get(keyArgs,'isNull');var datums=def.query(atomz).select(function(atoms){var datum=new pvc.data.Datum(this,atoms);if(isNullFun&&isNullFun(datum)){datum.isNull=true}if(whereFun&&!whereFun(datum)){return null}return datum},this);data_setDatums.call(this,datums,{doAtomGC:true})},clearVirtuals:function(){var datums=this._datums;if(datums){this._sumAbsCache=null;var visibleDatums=this._visibleDatums;var selectedDatums=this._selectedDatums;var i=0;var L=datums.length;var removed;while(i<L){var datum=datums[i];if(datum.isVirtual){var id=datum.id;if(selectedDatums&&datum.isSelected){selectedDatums.rem(id)}if(datum.isVisible){visibleDatums.rem(id)}datums.splice(i,1);L--;removed=true}else{i++}}if(removed){if(!datums.length&&this.parent){this.dispose();return}var children=this._children;if(children){i=0;L=children.length;while(i<L){var childData=children[i];childData.clearVirtuals();if(!childData.parent){L--}else{i++}}}if(this._linkChildren){this._linkChildren.forEach(function(linkChildData){linkChildData.clearVirtuals()})}}}def.eachOwn(this._dimensions,function(dim){dim_uninternVirtualAtoms.call(dim)})},add:function(datums){data_assertIsOwner.call(this);data_setDatums.call(this,datums,{isAdditive:true,doAtomGC:true})},groupBy:function(groupingSpecText,keyArgs){var groupOper=new pvc.data.GroupingOper(this,groupingSpecText,keyArgs),cacheKey=groupOper.key,groupByCache,data;if(cacheKey){groupByCache=this._groupByCache;data=groupByCache&&groupByCache[cacheKey]}if(!data){if(pvc.debug>=7){pvc.log("[GroupBy] "+(cacheKey?("Cache key not found: '"+cacheKey+"'"):"No Cache key"))}data=groupOper.execute();if(cacheKey){(groupByCache||(this._groupByCache={}))[cacheKey]=data}}else if(pvc.debug>=7){pvc.log("[GroupBy] Cache key hit '"+cacheKey+"'")}return data},flattenBy:function(role,keyArgs){var grouping=role.flattenedGrouping(keyArgs)||def.fail.operationInvalid("Role is unbound.");return this.groupBy(grouping,keyArgs)},where:function(whereSpec,keyArgs){var datums=this.datums(whereSpec,keyArgs);return new pvc.data.Data({linkParent:this,datums:datums})},datums:function(whereSpec,keyArgs){if(!whereSpec){if(!keyArgs){return def.query(this._datums)}return data_whereState(def.query(this._datums),keyArgs)}whereSpec=data_processWhereSpec.call(this,whereSpec,keyArgs);return data_where.call(this,whereSpec,keyArgs)},datum:function(whereSpec,keyArgs){whereSpec||def.fail.argumentRequired('whereSpec');whereSpec=data_processWhereSpec.call(this,whereSpec,keyArgs);var datum=data_where.call(this,whereSpec,keyArgs).first()||null;if(!datum&&def.get(keyArgs,'createNull')&&whereSpec.length){var sourceDatumFilter=whereSpec[0],atoms={};for(var dimName in this._dimensions){var dimAtoms=sourceDatumFilter[dimName];if(dimAtoms){atoms[dimName]=dimAtoms[0]}}datum=new pvc.data.Datum(this,atoms,true)}return datum},firstDatum:function(){return this._datums.length?this._datums[0]:null},dimensionsSumAbs:function(dimName,keyArgs){var key=dimName+":"+dim_buildDatumsFilterKey(keyArgs),sum=def.getOwn(this._sumAbsCache,key);if(sum==null){sum=this.children().where(function(childData){return!childData._isFlattenGroup||childData._isDegenerateFlattenGroup}).select(function(childData){return Math.abs(childData.dimensions(dimName).sum(keyArgs))},this).reduce(def.add,0);(this._sumAbsCache||(this._sumAbsCache={}))[key]=sum}return sum}});function data_setDatums(newDatums,keyArgs){newDatums||def.fail.argumentRequired('newDatums');var doAtomGC=def.get(keyArgs,'doAtomGC',false);var isAdditive=def.get(keyArgs,'isAdditive',false);var visibleDatums=this._visibleDatums;var selectedDatums=this._selectedDatums;var newDatumsByKey={};var prevDatumsByKey;var prevDatums=this._datums;if(prevDatums){var processPrevAtoms=isAdditive&&doAtomGC;prevDatumsByKey=def.query(prevDatums).uniqueIndex(function(datum){if(processPrevAtoms){data_processDatumAtoms.call(this,datum,false,true)}return datum.key},this);if(isAdditive){this._sumAbsCache=null}else{data_disposeChildLists.call(this);if(selectedDatums){selectedDatums.clear()}visibleDatums.clear()}}else{isAdditive=false}var datumsById;if(isAdditive){datumsById=this._datumsById}else{datumsById=this._datumsById={}}if(def.array.is(newDatums)){var i=0;var L=newDatums.length;while(i<L){var inDatum=newDatums[i];var outDatum=setDatum.call(this,inDatum);if(!outDatum){newDatums.splice(i,1);L--}else{if(outDatum!==inDatum){newDatums[i]=outDatum}i++}}}else if(newDatums instanceof def.Query){newDatums=newDatums.select(setDatum,this).where(def.notNully).array()}else{throw def.error.argumentInvalid('newDatums',"Argument is of invalid type.")}if(doAtomGC){def.eachOwn(this._dimensions,function(dimension){dim_uninternUnvisitedAtoms.call(dimension)})}if(isAdditive){def.array.append(prevDatums,newDatums);if(this._linkChildren){this._linkChildren.forEach(function(linkChildData){data_addDatumsSimple.call(linkChildData,newDatums)})}}else{this._datums=newDatums}function setDatum(newDatum){if(!newDatum){return}var key=newDatum.key;if(def.hasOwnProp.call(newDatumsByKey,key)){return}if(prevDatumsByKey){var prevDatum=def.getOwn(prevDatumsByKey,key);if(prevDatum){if(isAdditive){return}newDatum=prevDatum}}newDatumsByKey[key]=newDatum;var id=newDatum.id;datumsById[id]=newDatum;data_processDatumAtoms.call(this,newDatum,!!this._dimensions,doAtomGC);if(!newDatum.isNull){if(selectedDatums&&newDatum.isSelected){selectedDatums.set(id,newDatum)}if(newDatum.isVisible){visibleDatums.set(id,newDatum)}}return newDatum}}function data_processDatumAtoms(datum,intern,markVisited){var dims=this._dimensions;if(!dims){intern=false}def.each(datum.atoms,function(atom){if(intern){var localDim=def.getOwn(dims,atom.dimension.name)||def.fail.argumentInvalid("Datum has atoms of foreign dimension.");dim_internAtom.call(localDim,atom)}if(markVisited){atom.visited=true}})}function data_addDatumsSimple(newDatums){newDatums||def.fail.argumentRequired('newDatums');var groupOper=this._groupOper;if(groupOper){newDatums=groupOper.executeAdd(this,newDatums)}else{data_addDatumsLocal.call(this,newDatums)}if(this._linkChildren){this._linkChildren.forEach(function(linkChildData){data_addDatumsSimple.call(linkChildData,newDatums)})}}function data_addDatumsLocal(newDatums){var visibleDatums=this._visibleDatums;var selectedDatums=this._selectedDatums;this._sumAbsCache=null;var datumsById=this._datumsById;var datums=this._datums;newDatums.forEach(addDatum,this);function addDatum(newDatum){var id=newDatum.id;datumsById[id]=newDatum;data_processDatumAtoms.call(this,newDatum,true,false);if(!newDatum.isNull){if(selectedDatums&&newDatum.isSelected){selectedDatums.set(id,newDatum)}if(newDatum.isVisible){visibleDatums.set(id,newDatum)}}datums.push(newDatum)}}function data_processWhereSpec(whereSpec){var whereProcSpec=[];whereSpec=def.array.as(whereSpec);if(whereSpec){whereSpec.forEach(processDatumFilter,this)}return whereProcSpec;function processDatumFilter(datumFilter){if(datumFilter!=null){(typeof datumFilter==='object')||def.fail.invalidArgument('datumFilter');var datumProcFilter={},any=false;for(var dimName in datumFilter){var atoms=processDimensionFilter.call(this,dimName,datumFilter[dimName]);if(atoms){any=true;datumProcFilter[dimName]=atoms}}if(any){whereProcSpec.push(datumProcFilter)}}}function processDimensionFilter(dimName,values){var dimension=this.dimensions(dimName),atoms=def.query(values).select(function(value){return dimension.atom(value)}).where(def.notNully).distinct(function(atom){return atom.key}).array();return atoms.length?atoms:null}}function data_whereState(q,keyArgs){var selected=def.get(keyArgs,'selected'),visible=def.get(keyArgs,'visible'),where=def.get(keyArgs,'where'),isNull=def.get(keyArgs,'isNull');if(visible!=null){q=q.where(function(datum){return datum.isVisible===visible})}if(isNull!=null){q=q.where(function(datum){return datum.isNull===isNull})}if(selected!=null){q=q.where(function(datum){return datum.isSelected===selected})}if(where){q=q.where(where)}return q}function data_where(whereSpec,keyArgs){var orderBys=def.array.as(def.get(keyArgs,'orderBy')),datumKeyArgs=def.create(keyArgs||{},{orderBy:null});var query=def.query(whereSpec).selectMany(function(datumFilter,index){if(orderBys){datumKeyArgs.orderBy=orderBys[index]}return data_whereDatumFilter.call(this,datumFilter,datumKeyArgs)},this);return query.distinct(function(datum){return datum.id})}function data_whereDatumFilter(datumFilter,keyArgs){var groupingSpecText=keyArgs.orderBy;if(!groupingSpecText){groupingSpecText=Object.keys(datumFilter).sort().join(',')}else{if(groupingSpecText.indexOf("|")>=0){throw def.error.argumentInvalid('keyArgs.orderBy',"Multi-dimension order by is not supported.")}}var rootData=this.groupBy(groupingSpecText,keyArgs),H=rootData.treeHeight;var stateStack=[];return def.query(function(){var state;if(!this._data){this._data=rootData;this._dimAtomsOrQuery=def.query(datumFilter[rootData._groupLevelSpec.dimensions[0].name])}else if(this._datumsQuery){this._data||def.assert("Must have a current data");stateStack.length||def.assert("Must have a parent data");!this._dimAtomsOrQuery||def.assert();if(this._datumsQuery.next()){this.item=this._datumsQuery.item;return 1}this._datumsQuery=null;state=stateStack.pop();this._data=state.data;this._dimAtomsOrQuery=state.dimAtomsOrQuery}this._dimAtomsOrQuery||def.assert("Invalid programmer");this._data||def.assert("Must have a current data");var depth=stateStack.length;do{while(this._dimAtomsOrQuery.next()){var dimAtomOr=this._dimAtomsOrQuery.item,childData=this._data._childrenByKey[dimAtomOr.key];if(childData&&(depth<H-1||childData._datums.length)){stateStack.push({data:this._data,dimAtomsOrQuery:this._dimAtomsOrQuery});this._data=childData;if(depth<H-1){this._dimAtomsOrQuery=def.query(datumFilter[childData._groupLevelSpec.dimensions[0].name]);depth++}else{this._dimAtomsOrQuery=null;this._datumsQuery=def.query(childData._datums);this._datumsQuery.next();this.item=this._datumsQuery.item;return 1}}}if(!depth){return 0}state=stateStack.pop();this._data=state.data;this._dimAtomsOrQuery=state.dimAtomsOrQuery;depth--}while(true);return 0})}