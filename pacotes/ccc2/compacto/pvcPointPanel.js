def.type('pvc.PointPanel',pvc.CategoricalAbstractPanel).init(function(chart,parent,plot,options){this.base(chart,parent,plot,options);this.linesVisible=plot.option('LinesVisible');this.dotsVisible=plot.option('DotsVisible');this.areasVisible=plot.option('AreasVisible');if(!this.linesVisible&&!this.dotsVisible&&!this.areasVisible){this.linesVisible=true;plot.option.specify({'LinesVisible':true})}}).add({pvLine:null,pvArea:null,pvDot:null,pvLabel:null,pvScatterPanel:null,_creating:function(){var groupScene=this.defaultVisibleBulletGroupScene();if(groupScene&&!groupScene.hasRenderer()){var colorAxis=groupScene.colorAxis;var drawMarker=def.nullyTo(colorAxis.option('LegendDrawMarker',true),this.dotsVisible||this.areasVisible);var drawRule=!drawMarker||def.nullyTo(colorAxis.option('LegendDrawLine',true),this.linesVisible&&!this.areasVisible);if(drawMarker||drawRule){var keyArgs={};if((keyArgs.drawMarker=drawMarker)){var markerShape=colorAxis.option('LegendShape',true);if(this.dotsVisible){if(!markerShape){markerShape='circle'}keyArgs.markerPvProto=new pv.Dot().lineWidth(1.5,pvc.extensionTag).shapeSize(12,pvc.extensionTag)}else{keyArgs.markerPvProto=new pv.Mark()}keyArgs.markerShape=markerShape;if(this._applyV1BarSecondExtensions){this.chart.extend(keyArgs.markerPvProto,'barSecondDot',{constOnly:true})}this.extend(keyArgs.markerPvProto,'dot',{constOnly:true})}if((keyArgs.drawRule=drawRule)){keyArgs.rulePvProto=new pv.Line().lineWidth(1.5,pvc.extensionTag);if(this._applyV1BarSecondExtensions){this.chart.extend(keyArgs.rulePvProto,'barSecondLine',{constOnly:true})}this.extend(keyArgs.rulePvProto,'line',{constOnly:true})}groupScene.renderer(new pvc.visual.legend.BulletItemDefaultRenderer(keyArgs))}}},_createCore:function(){this.base();var myself=this;var chart=this.chart;var isStacked=this.stacked;var dotsVisible=this.dotsVisible;var areasVisible=this.areasVisible;var linesVisible=this.linesVisible;var anchor=this.isOrientationVertical()?"bottom":"left";this.valueRole=chart.visualRoles(this.plot.option('OrthoRole'));this.valueRoleName=this.valueRole.name;this.valueDimName=this.valueRole.firstDimensionName();var isBaseDiscrete=this.axes.base.role.grouping.isDiscrete();var data=this.visibleData();var rootScene=this._buildScene(data,isBaseDiscrete);if(areasVisible){this.pvPanel.zOrder(-7)}else{this.pvPanel.zOrder(1)}this.pvScatterPanel=new pvc.visual.Panel(this,this.pvPanel,{extensionId:'panel'}).lock('data',rootScene.childNodes).pvMark;var areaFillColorAlpha=areasVisible&&linesVisible&&!isStacked?0.5:null;var wrapper;if(this.compatVersion()<=1){if(isStacked){wrapper=function(v1f){return function(dotScene){return v1f.call(this,dotScene.vars.value.rawValue)}}}else{wrapper=function(v1f){return function(dotScene){var d={category:dotScene.vars.category.rawValue,value:dotScene.vars.value.rawValue};var pseudo=Object.create(this);pseudo.index=dotScene.dataIndex;return v1f.call(pseudo,d)}}}}var isLineAreaVisible=isBaseDiscrete&&isStacked?function(){return!this.scene.isNull||this.scene.isIntermediate}:function(){return!this.scene.isNull};var isLineAreaNoSelect=chart._canSelectWithFocusWindow();this.pvArea=new pvc.visual.Area(this,this.pvScatterPanel,{extensionId:'area',noTooltip:false,wrapper:wrapper,noSelect:isLineAreaNoSelect,showsSelection:!isLineAreaNoSelect}).lock('visible',isLineAreaVisible).lock('data',function(seriesScene){return seriesScene.childNodes}).override('x',function(){return this.scene.basePosition}).override('y',function(){return this.scene.orthoPosition}).override('dy',function(){return chart.animate(0,this.scene.orthoLength)}).override('color',function(type){return areasVisible?this.base(type):null}).override('baseColor',function(type){var color=this.base(type);if(!this._finished&&color&&areaFillColorAlpha!=null){color=color.alpha(areaFillColorAlpha)}return color}).override('dimColor',function(color,type){return isStacked?pvc.toGrayScale(color,1,null,null).brighter():this.base(color,type)}).lock('events',areasVisible?'painted':'none').pvMark;var dotsVisibleOnly=dotsVisible&&!linesVisible&&!areasVisible,lineCopiesAreaColor=!linesVisible&&areasVisible,darkerLineAndDotColor=isStacked&&areasVisible;var extensionIds=['line'];if(this._applyV1BarSecondExtensions){extensionIds.push({abs:'barSecondLine'})}var isLineVisible=!dotsVisibleOnly&&isLineAreaVisible;this.pvLine=new pvc.visual.Line(this,this.pvArea.anchor(this.anchorOpposite(anchor)),{extensionId:extensionIds,freePosition:true,wrapper:wrapper,noTooltip:false,noSelect:isLineAreaNoSelect,showsSelection:!isLineAreaNoSelect}).lock('visible',isLineVisible).override('defaultColor',function(type){var color=this.base(type);if(!this._finished&&darkerLineAndDotColor&&color){color=color.darker(0.6)}return color}).override('normalColor',function(color,type){return linesVisible?color:null}).override('baseStrokeWidth',function(){var strokeWidth;if(linesVisible){strokeWidth=this.base()}return strokeWidth==null?1.5:strokeWidth}).intercept('strokeDasharray',function(){var dashArray=this.delegateExtension();if(dashArray===undefined){var scene=this.scene;var useDash=scene.isInterpolated;if(!useDash){var next=scene.nextSibling;useDash=next&&next.isIntermediate&&next.isInterpolated;if(!useDash){var previous=scene.previousSibling;useDash=previous&&scene.isIntermediate&&previous.isInterpolated}}dashArray=useDash?'. ':null}return dashArray}).pvMark;var showAloneDots=!(areasVisible&&isBaseDiscrete&&isStacked);extensionIds=['dot'];if(this._applyV1BarSecondExtensions){extensionIds.push({abs:'barSecondDot'})}this.pvDot=new pvc.visual.Dot(this,this.pvLine,{extensionId:extensionIds,freePosition:true,wrapper:wrapper}).intercept('visible',function(){var scene=this.scene;return(!scene.isNull&&!scene.isIntermediate)&&this.delegateExtension(true)}).override('color',function(type){if(!dotsVisible){var visible=this.scene.isActive||(!showAloneDots&&this.scene.isSingle)||(showAloneDots&&this.scene.isAlone);if(!visible){return pvc.invisibleFill}}if(this.scene.isInterpolated&&type==='fill'){var color=this.base(type);return color&&pv.color(color).brighter(0.5)}return this.base(type)}).optionalMark('lineCap','round').override('defaultColor',function(type){var color=this.base(type);if(!this._finished&&darkerLineAndDotColor&&color){color=color.darker(0.6)}return color}).override('baseSize',function(){if(!dotsVisible){var visible=this.scene.isActive||(!showAloneDots&&this.scene.isSingle)||(showAloneDots&&this.scene.isAlone);if(visible&&!this.scene.isActive){var lineWidth=Math.max(myself.pvLine.lineWidth(),0.2)/2;return lineWidth*lineWidth}}if(this.scene.isInterpolated){return 0.8*this.base()}return this.base()}).pvMark;if(this.valuesVisible){this.pvLabel=new pvc.visual.Label(this,this.pvDot.anchor(this.valuesAnchor),{extensionId:'label',wrapper:wrapper}).pvMark.font(this.valuesFont).text(function(scene){return scene.vars.value.label})}},renderInteractive:function(){this.pvScatterPanel.render()},_getSelectableMarks:function(){var marks=[];marks.push(this.pvDot);if(this.linesVisible||this.areasVisible){marks.push(this.pvLine)}return marks},_buildScene:function(data,isBaseDiscrete){var rootScene=new pvc.visual.Scene(null,{panel:this,group:data});var categDatas=data._children;var chart=this.chart;var colorVarHelper=new pvc.visual.RoleVarHelper(chart,chart._colorRole);var valueDim=data.owner.dimensions(this.valueDimName);var isStacked=this.stacked;var visibleKeyArgs={visible:true,zeroIfNone:false};var orthoScale=this.axes.ortho.scale;var orthoNullValue=def.scope(function(){var domain=orthoScale.domain(),dmin=domain[0],dmax=domain[1];if(dmin*dmax>=0){return dmin>=0?dmin:dmax}return 0});var orthoZero=orthoScale(orthoNullValue);var sceneBaseScale=this.axes.base.sceneScale({sceneVarName:'category'});def.scope(function(){var serRole=chart._serRole;return(serRole&&serRole.grouping)?serRole.flatten(data).children():def.query([null])}).each(function(seriesData1){var seriesScene=new pvc.visual.Scene(rootScene,{group:seriesData1||data});seriesScene.vars.series=pvc.visual.ValueLabelVar.fromComplex(seriesData1);colorVarHelper.onNewScene(seriesScene,false);categDatas.forEach(function(categData,categIndex){var group=categData;if(seriesData1){group=group._childrenByKey[seriesData1.key]}var value=group?group.dimensions(valueDim.name).sum(visibleKeyArgs):null;var serCatScene=new pvc.visual.Scene(seriesScene,{group:group});serCatScene.dataIndex=categIndex;serCatScene.vars.category=pvc.visual.ValueLabelVar.fromComplex(categData);var valueVar=new pvc.visual.ValueLabelVar(value,valueDim.format(value),value);valueVar.accValue=value!=null?value:orthoNullValue;serCatScene.vars.value=valueVar;colorVarHelper.onNewScene(serCatScene,true);var isInterpolated=false;if(group){var firstDatum=group._datums[0];if(firstDatum&&firstDatum.isInterpolated){isInterpolated=true}}serCatScene.isInterpolated=isInterpolated;serCatScene.isNull=value==null;serCatScene.isIntermediate=false},this)},this);var reversedSeriesScenes=rootScene.children().reverse().array();var belowSeriesScenes2;reversedSeriesScenes.forEach(completeSeriesScenes,this);reversedSeriesScenes.forEach(trimNullSeriesScenes,this);return rootScene;function completeSeriesScenes(seriesScene){var seriesScenes2=[],seriesScenes=seriesScene.childNodes,fromScene,notNullCount=0,firstAloneScene=null;for(var c=0,toChildIndex=0,categCount=seriesScenes.length;c<categCount;c++,toChildIndex++){var toScene=seriesScenes[toChildIndex],c2=c*2;seriesScenes2[c2]=toScene;completeMainScene.call(this,fromScene,toScene,belowSeriesScenes2&&belowSeriesScenes2[c2]);if(toScene.isAlone&&!firstAloneScene){firstAloneScene=toScene}if(!toScene.isNull){notNullCount++}if(fromScene){var interScene=createIntermediateScene.call(this,seriesScene,fromScene,toScene,toChildIndex,belowSeriesScenes2&&belowSeriesScenes2[c2-1]);if(interScene){seriesScenes2[c2-1]=interScene;toChildIndex++}}fromScene=toScene}if(notNullCount===1&&firstAloneScene&&categCount===1){firstAloneScene.isSingle=true}if(isStacked){belowSeriesScenes2=seriesScenes2}}function completeMainScene(fromScene,toScene,belowScene){var toAccValue=toScene.vars.value.accValue;if(belowScene){if(toScene.isNull&&!isBaseDiscrete){toAccValue=orthoNullValue}else{toAccValue+=belowScene.vars.value.accValue}toScene.vars.value.accValue=toAccValue}toScene.basePosition=sceneBaseScale(toScene);toScene.orthoPosition=orthoZero;toScene.orthoLength=orthoScale(toAccValue)-orthoZero;var isNullFrom=(!fromScene||fromScene.isNull),isAlone=isNullFrom&&!toScene.isNull;if(isAlone){var nextScene=toScene.nextSibling;isAlone=!nextScene||nextScene.isNull}toScene.isAlone=isAlone;toScene.isSingle=false}function createIntermediateScene(seriesScene,fromScene,toScene,toChildIndex,belowScene){var interIsNull=fromScene.isNull||toScene.isNull;if(interIsNull&&!this.areasVisible){return null}var interValue,interAccValue,interBasePosition;if(interIsNull){if(belowScene&&isBaseDiscrete){var belowValueVar=belowScene.vars.value;interAccValue=belowValueVar.accValue;interValue=belowValueVar[this.valueRoleName]}else{interValue=interAccValue=orthoNullValue}if(isStacked&&isBaseDiscrete){interBasePosition=toScene.basePosition-(sceneBaseScale.range().step/2)}else if(fromScene.isNull){interBasePosition=toScene.basePosition}else{interBasePosition=fromScene.basePosition}}else{var fromValueVar=fromScene.vars.value,toValueVar=toScene.vars.value;interValue=(toValueVar.value+fromValueVar.value)/2;interAccValue=(toValueVar.accValue+fromValueVar.accValue)/2;interBasePosition=(toScene.basePosition+fromScene.basePosition)/2}var interScene=new pvc.visual.Scene(seriesScene,{index:toChildIndex,group:toScene.group,datum:toScene.group?null:toScene.datum});interScene.dataIndex=toScene.dataIndex;interScene.vars.category=toScene.vars.category;var interValueVar=new pvc.visual.ValueLabelVar(interValue,valueDim.format(interValue),interValue);interValueVar.accValue=interAccValue;interScene.vars.value=interValueVar;interScene.ownerScene=toScene;interScene.isInterpolated=toScene.isInterpolated;interScene.isIntermediate=true;interScene.isSingle=false;interScene.isNull=interIsNull;interScene.isAlone=interIsNull&&toScene.isNull&&fromScene.isNull;interScene.basePosition=interBasePosition;interScene.orthoPosition=orthoZero;interScene.orthoLength=orthoScale(interAccValue)-orthoZero;colorVarHelper.onNewScene(interScene,true);return interScene}function trimNullSeriesScenes(seriesScene){var seriesScenes=seriesScene.childNodes,L=seriesScenes.length;var scene,siblingScene;while(L&&(scene=seriesScenes[0]).isNull){siblingScene=scene.nextSibling;if(siblingScene&&!siblingScene.isNull){break}seriesScene.removeAt(0);L--}while(L&&(scene=seriesScenes[L-1]).isNull){siblingScene=scene.previousSibling;if(siblingScene&&!siblingScene.isNull){break}seriesScene.removeAt(L-1);L--}}}});