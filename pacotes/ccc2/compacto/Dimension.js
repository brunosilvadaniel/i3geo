def.type('pvc.data.Dimension').init(function(data,type){this.data=data;this.type=type;this.root=this;this.owner=this;var name=type.name;this.name=name;this._atomComparer=type.atomComparer();this._atomsByKey={};if(data.isOwner()){this._atoms=[];dim_createVirtualNullAtom.call(this)}else{var parentData=data.parent;var source;if(parentData){source=parentData._dimensions[name];dim_addChild.call(source,this);this.root=data.parent.root}else{parentData=data.linkParent;parentData||def.assert("Data must have a linkParent");source=parentData._dimensions[name];dim_addLinkChild.call(source,this)}this._nullAtom=this.owner._nullAtom;this._lazyInit=function(){this._lazyInit=null;var datums=this.data._datums;var L=datums.length;var atomsByKey=this._atomsByKey;for(var i=0;i<L;i++){var atom=datums[i].atoms[name];atomsByKey[atom.key]=atom}this._atoms=source.atoms().filter(function(atom){return def.hasOwnProp.call(atomsByKey,atom.key)})}}}).add({parent:null,linkParent:null,_children:null,_linkChildren:null,_atomsByKey:null,_atomVisibleDatumsCount:null,_disposed:false,_nullAtom:null,_virtualNullAtom:null,_visibleAtoms:null,_visibleIndexes:null,_atomComparer:null,_atoms:null,_sumCache:null,count:function(){if(this._lazyInit){this._lazyInit()}return this._atoms.length},isVisible:function(atom){if(this._lazyInit){this._lazyInit()}def.hasOwn(this._atomsByKey,atom.key)||def.assert("Atom must exist in this dimension.");return dim_getVisibleDatumsCountMap.call(this)[atom.key]>0},atoms:function(keyArgs){if(this._lazyInit){this._lazyInit()}var visible=def.get(keyArgs,'visible');if(visible==null){return this._atoms}visible=!!visible;this._visibleAtoms||(this._visibleAtoms={});return this._visibleAtoms[visible]||(this._visibleAtoms[visible]=dim_calcVisibleAtoms.call(this,visible))},indexes:function(keyArgs){if(this._lazyInit){this._lazyInit()}var visible=def.get(keyArgs,'visible');if(visible==null){return pv.range(0,this._atoms.length)}visible=!!visible;this._visibleIndexes||(this._visibleIndexes={});return this._visibleIndexes[visible]||(this._visibleIndexes[visible]=dim_calcVisibleIndexes.call(this,visible))},atom:function(value){if(value==null||value===''){return this._nullAtom}if(value instanceof pvc.data.Atom){return value}if(this._lazyInit){this._lazyInit()}var key=this.type._key?this.type._key.call(null,value):value;return this._atomsByKey[key]||null},extent:function(keyArgs){var atoms=this.atoms(keyArgs);var L=atoms.length;if(!L){return undefined}var offset=this._nullAtom&&atoms[0].value==null?1:0;var countWithoutNull=L-offset;if(countWithoutNull>0){var min=atoms[offset];var max=atoms[L-1];var tmp;if(min!==max&&def.get(keyArgs,'abs',false)){var minSign=min.value<0?-1:1;var maxSign=max.value<0?-1:1;if(minSign===maxSign){if(maxSign<0){tmp=max;max=min;min=tmp}}else if(countWithoutNull>2){if(max.value<-min.value){max=min}var zeroIndex=def.array.binarySearch(atoms,0,this.type.comparer(),function(a){return a.value});if(zeroIndex<0){zeroIndex=~zeroIndex;var negAtom=atoms[zeroIndex-1];var posAtom=atoms[zeroIndex];if(-negAtom.value<posAtom.value){min=negAtom}else{min=posAtom}}else{min=atoms[zeroIndex]}}else if(max.value<-min.value){tmp=max;max=min;min=tmp}}return{min:min,max:max}}return undefined},min:function(keyArgs){var atoms=this.atoms(keyArgs);var L=atoms.length;if(!L){return undefined}var offset=this._nullAtom&&atoms[0].value==null?1:0;return(L>offset)?atoms[offset]:undefined},max:function(keyArgs){var atoms=this.atoms(keyArgs);var L=atoms.length;return L&&atoms[L-1].value!=null?atoms[L-1]:undefined},sum:function(keyArgs){var isAbs=!!def.get(keyArgs,'abs',false),zeroIfNone=def.get(keyArgs,'zeroIfNone',true),key=dim_buildDatumsFilterKey(keyArgs)+':'+isAbs;var sum=def.getOwn(this._sumCache,key);if(sum===undefined){var dimName=this.name;sum=this.data.datums(null,keyArgs).reduce(function(sum2,datum){var value=datum.atoms[dimName].value;if(isAbs&&value<0){value=-value}return sum2!=null?(sum2+value):value},null);(this._sumCache||(this._sumCache={}))[key]=sum}return zeroIfNone?(sum||0):sum},percent:function(atomOrValue,keyArgs){var value=(atomOrValue instanceof pvc.data.Atom)?atomOrValue.value:atomOrValue;if(!value){return 0}var sum=this.sum(def.create(keyArgs,{abs:true}));return sum?(Math.abs(value)/sum):0},percentOverParent:function(keyArgs){var value=this.sum(keyArgs);if(!value){return 0}var parentData=this.data.parent;if(!parentData){return 0}var sum=parentData.dimensionsSumAbs(this.name,keyArgs);return sum?(Math.abs(value)/sum):0},format:function(value,sourceValue){return""+(this.type._formatter?this.type._formatter.call(null,value,sourceValue):"")},intern:function(sourceValue,isVirtual){if(sourceValue==null||sourceValue===''){return this._nullAtom||dim_createNullAtom.call(this,sourceValue)}if(sourceValue instanceof pvc.data.Atom){if(sourceValue.dimension!==this){throw def.error.operationInvalid("Atom is of a different dimension.")}return sourceValue}var value,label;var type=this.type;if(typeof sourceValue==='object'&&('v'in sourceValue)){label=sourceValue.f;sourceValue=sourceValue.v}if(!isVirtual){var converter=type._converter;value=converter?converter(sourceValue):sourceValue;if(value==null||value===''){return this._nullAtom||dim_createNullAtom.call(this,sourceValue)}}else{value=sourceValue}var cast=type.cast;if(cast){value=cast(value);if(value==null||value===''){return this._nullAtom||dim_createNullAtom.call(this)}}var keyFun=type._key;var key=''+(keyFun?keyFun(value):value);key||def.fail.operationInvalid("Only a null value can have an empty key.");var atom=this._atomsByKey[key];if(atom){if(!isVirtual&&atom.isVirtual){delete atom.isVirtual}return atom}return dim_createAtom.call(this,type,sourceValue,key,value,label,isVirtual)},dispose:function(){if(!this._disposed){data_disposeChildList(this._children,'parent');data_disposeChildList(this._linkChildren,'linkParent');if(this.parent){dim_removeChild.call(this.parent,this)}if(this.linkParent){dim_removeLinkChild.call(this.linkParent,this)}dim_clearVisiblesCache.call(this);this._lazyInit=null;this._atoms=this._nullAtom=this._virtualNullAtom=null;this._disposed=true}}});function dim_createAtom(type,sourceValue,key,value,label,isVirtual){var atom;if(this.owner===this){if(label==null){var formatter=type._formatter;if(formatter){label=formatter(value,sourceValue)}else{label=value}}label=""+label;if(!label&&pvc.debug>=2){pvc.log("Only the null value should have an empty label.")}atom=new pvc.data.Atom(this,value,label,sourceValue,key);if(isVirtual){atom.isVirtual=true}}else{var source=this.parent||this.linkParent;atom=source._atomsByKey[key]||dim_createAtom.call(source,type,sourceValue,key,value,label,isVirtual)}def.array.insert(this._atoms,atom,this._atomComparer);dim_clearVisiblesCache.call(this);this._atomsByKey[key]=atom;return atom}function dim_internAtom(atom){var key=atom.key;if(atom.dimension===this){(this.owner===this)||def.assert("Should be an owner dimension");if(!key&&atom===this._virtualNullAtom){atom=this.intern(null)}return atom}if(!this._lazyInit){var localAtom=this._atomsByKey[key];if(localAtom){if(localAtom!==atom){throw def.error.operationInvalid("Atom is from a different root data.")}return atom}if(this.owner===this){throw def.error.operationInvalid("Atom is from a different root data.")}}dim_internAtom.call(this.parent||this.linkParent,atom);if(!this._lazyInit){this._atomsByKey[key]=atom;if(!key){this._nullAtom=atom;this._atoms.unshift(atom)}else{def.array.insert(this._atoms,atom,this._atomComparer)}dim_clearVisiblesCache.call(this)}return atom}function dim_buildDatumsFilterKey(keyArgs){var visible=def.get(keyArgs,'visible'),selected=def.get(keyArgs,'selected');return(visible==null?null:!!visible)+':'+(selected==null?null:!!selected)}function dim_createNullAtom(sourceValue){var nullAtom=this._nullAtom;if(!nullAtom){if(this.owner===this){var typeFormatter=this.type._formatter;var label=""+(typeFormatter?typeFormatter.call(null,null,sourceValue):"");nullAtom=new pvc.data.Atom(this,null,label,null,'');this.data._atomsBase[this.name]=nullAtom}else{nullAtom=dim_createNullAtom.call(this.parent||this.linkParent,sourceValue)}this._atomsByKey['']=this._nullAtom=nullAtom;this._atoms.unshift(nullAtom)}return nullAtom}function dim_createVirtualNullAtom(){(this.owner===this)||def.assert("Can only create atoms on an owner dimension.");if(!this._virtualNullAtom){this._virtualNullAtom=new pvc.data.Atom(this,null,"",null,'');this.data._atomsBase[this.name]=this._virtualNullAtom}return this._virtualNullAtom}function dim_unintern(atom){(this.owner===this)||def.assert("Can only unintern atoms on an owner dimension.");(atom&&atom.dimension===this)||def.assert("Not an interned atom");if(atom===this._virtualNullAtom){return}var key=atom.key;if(this._atomsByKey[key]===atom){def.array.remove(this._atoms,atom,this._atomComparer);delete this._atomsByKey[key];if(!key){delete this._nullAtom;this.data._atomsBase[this.name]=this._virtualNullAtom}}dim_clearVisiblesCache.call(this)}function dim_uninternUnvisitedAtoms(){(this.owner===this)||def.assert("Can only unintern atoms of an owner dimension.");var atoms=this._atoms;if(atoms){var atomsByKey=this._atomsByKey;var i=0;var L=atoms.length;while(i<L){var atom=atoms[i];if(atom.visited){delete atom.visited;i++}else if(atom!==this._virtualNullAtom){atoms.splice(i,1);L--;var key=atom.key;delete atomsByKey[key];if(!key){delete this._nullAtom;this.data._atomsBase[this.name]=this._virtualNullAtom}}}dim_clearVisiblesCache.call(this)}}function dim_uninternVirtualAtoms(){var atoms=this._atoms;if(atoms){var atomsByKey=this._atomsByKey;var i=0;var L=atoms.length;var removed;while(i<L){var atom=atoms[i];if(!atom.isVirtual){i++}else{atoms.splice(i,1);L--;removed=true;var key=atom.key||def.assert("Cannot be the null or virtual null atom.");delete atomsByKey[key]}}if(removed){dim_clearVisiblesCache.call(this)}}}function dim_clearVisiblesCache(){this._atomVisibleDatumsCount=this._sumCache=this._visibleAtoms=this._visibleIndexes=null}function dim_onDatumsChanged(){dim_clearVisiblesCache.call(this)}function dim_addChild(child){data_addColChild(this,'_children',child,'parent');child.owner=this.owner}function dim_removeChild(child){data_removeColChild(this,'_children',child,'parent')}function dim_addLinkChild(linkChild){data_addColChild(this,'_linkChildren',linkChild,'linkParent');linkChild.owner=this.owner}function dim_removeLinkChild(linkChild){data_removeColChild(this,'_linkChildren',linkChild,'linkParent')}function dim_onDatumVisibleChanged(datum,visible){var map;if(!this._disposed&&(map=this._atomVisibleDatumsCount)){var atom=datum.atoms[this.name],key=atom.key;def.hasOwn(this._atomsByKey,key)||def.assert("Atom must exist in this dimension.");var count=map[key];(visible||(count>0))||def.assert("Must have had accounted for at least one visible datum.");map[key]=(count||0)+(visible?1:-1);this._visibleAtoms=this._sumCache=this._visibleIndexes=null}}function dim_getVisibleDatumsCountMap(){var map=this._atomVisibleDatumsCount;if(!map){map={};this.data.datums(null,{visible:true}).each(function(datum){var atom=datum.atoms[this.name],key=atom.key;map[key]=(map[key]||0)+1},this);this._atomVisibleDatumsCount=map}return map}function dim_calcVisibleIndexes(visible){var indexes=[];this._atoms.forEach(function(atom,index){if(this.isVisible(atom)===visible){indexes.push(index)}},this);return indexes}function dim_calcVisibleAtoms(visible){return def.query(this._atoms).where(function(atom){return this.isVisible(atom)===visible},this).array()}