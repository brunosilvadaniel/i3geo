def.type('pvc.MultiChartPanel',pvc.BasePanel).add({anchor:'fill',_multiInfo:null,createSmallCharts:function(){var chart=this.chart;var options=chart.options;var multiChartMax=Number(options.multiChartMax);if(isNaN(multiChartMax)||multiChartMax<1){multiChartMax=Infinity}var multiChartRole=chart.visualRoles('multiChart');var data=chart.data.flattenBy(multiChartRole,{visible:true});var leafCount=data._children.length;var count=Math.min(leafCount,multiChartMax);if(count===0){return}var multiChartColumnsMax=+options.multiChartColumnsMax;if(isNaN(multiChartColumnsMax)||multiChartMax<1){multiChartColumnsMax=3}var colCount=Math.min(count,multiChartColumnsMax);colCount>=1&&isFinite(colCount)||def.assert("Must be at least 1 and finite");var rowCount=Math.ceil(count/colCount);rowCount>=1||def.assert("Must be at least 1");var coordRootAxesByScopeType=this._getCoordinatedRootAxesByScopeType();var coordScopesByType,addChartToScope,indexChartByScope;if(coordRootAxesByScopeType){coordScopesByType={};addChartToScope=function(childChart,scopeType,scopeIndex){var scopes=def.array.lazy(coordScopesByType,scopeType);def.array.lazy(scopes,scopeIndex).push(childChart)};indexChartByScope=function(childChart){if(coordRootAxesByScopeType.row){addChartToScope(childChart,'row',childChart.smallRowIndex)}if(coordRootAxesByScopeType.column){addChartToScope(childChart,'column',childChart.smallColIndex)}if(coordRootAxesByScopeType.global){addChartToScope(childChart,'global',0)}}}var childOptionsBase=this._buildSmallChartsBaseOptions();var ChildClass=chart.constructor;for(var index=0;index<count;index++){var childData=data._children[index];var colIndex=(index%colCount);var rowIndex=Math.floor(index/colCount);var childOptions=def.set(Object.create(childOptionsBase),'smallColIndex',colIndex,'smallRowIndex',rowIndex,'title',childData.absLabel,'data',childData);var childChart=new ChildClass(childOptions);if(!coordRootAxesByScopeType){childChart._preRender()}else{childChart._preRenderPhase1();indexChartByScope(childChart)}}if(coordRootAxesByScopeType){def.eachOwn(coordRootAxesByScopeType,function(axes,scopeType){axes.forEach(function(axis){coordScopesByType[scopeType].forEach(function(scopeCharts){this._coordinateScopeAxes(axis.id,scopeCharts)},this)},this)},this);chart.children.forEach(function(childChart){childChart._preRenderPhase2()})}this._multiInfo={data:data,count:count,rowCount:rowCount,colCount:colCount,multiChartColumnsMax:multiChartColumnsMax,coordScopesByType:coordScopesByType}},_getCoordinatedRootAxesByScopeType:function(){var hasCoordination=false;var rootAxesByScopeType=def.query(this.chart.axesList).multipleIndex(function(axis){if(axis.scaleType!=='discrete'&&axis.option.isDefined('DomainScope')){var scopeType=axis.option('DomainScope');if(scopeType!=='cell'){hasCoordination=true;return scopeType}}});return hasCoordination?rootAxesByScopeType:null},_coordinateScopeAxes:function(axisId,scopeCharts){var unionExtent=def.query(scopeCharts).select(function(childChart){var scale=childChart.axes[axisId].scale;if(!scale.isNull){var domain=scale.domain();return{min:domain[0],max:domain[1]}}}).reduce(pvc.unionExtents,null);if(unionExtent){scopeCharts.forEach(function(childChart){var axis=childChart.axes[axisId];var scale=axis.scale;if(!scale.isNull){scale.domain(unionExtent.min,unionExtent.max);axis.setScale(scale)}})}},_buildSmallChartsBaseOptions:function(){var chart=this.chart;var options=chart.options;return def.set(Object.create(options),'parent',chart,'legend',false,'titleFont',options.smallTitleFont,'titlePosition',options.smallTitlePosition,'titleAlign',options.smallTitleAlign,'titleAlignTo',options.smallTitleAlignTo,'titleOffset',options.smallTitleOffset,'titleKeepInBounds',options.smallTitleKeepInBounds,'titleMargins',options.smallTitleMargins,'titlePaddings',options.smallTitlePaddings,'titleSize',options.smallTitleSize,'titleSizeMax',options.smallTitleSizeMax)},_calcLayout:function(layoutInfo){var multiInfo=this._multiInfo;if(!multiInfo){return}var chart=this.chart;var options=chart.options;var clientSize=layoutInfo.clientSize;var prevLayoutInfo=layoutInfo.previous;var initialClientWidth=prevLayoutInfo?prevLayoutInfo.initialClientWidth:clientSize.width;var initialClientHeight=prevLayoutInfo?prevLayoutInfo.initialClientHeight:clientSize.height;var smallWidth=pvc.PercentValue.parse(options.smallWidth);if(smallWidth!=null){smallWidth=pvc.PercentValue.resolve(smallWidth,initialClientWidth)}var smallHeight=pvc.PercentValue.parse(options.smallHeight);if(smallHeight!=null){smallHeight=pvc.PercentValue.resolve(smallHeight,initialClientHeight)}var ar=+options.smallAspectRatio;if(isNaN(ar)||ar<=0){ar=this._calulateDefaultAspectRatio()}if(smallWidth==null){if(isFinite(multiInfo.multiChartColumnsMax)){smallWidth=clientSize.width/multiInfo.colCount}else{if(smallHeight==null){smallHeight=initialClientHeight}smallWidth=ar*smallHeight}}if(smallHeight==null){if((multiInfo.rowCount===1&&def.get(options,'multiChartSingleRowFillsHeight',true))||(multiInfo.colCount===1&&def.get(options,'multiChartSingleColFillsHeight',true))){smallHeight=initialClientHeight}else{smallHeight=smallWidth/ar}}def.set(layoutInfo,'initialClientWidth',initialClientWidth,'initialClientHeight',initialClientHeight,'width',smallWidth,'height',smallHeight);return{width:smallWidth*multiInfo.colCount,height:Math.max(clientSize.height,smallHeight*multiInfo.rowCount)}},_calulateDefaultAspectRatio:function(){if(this.chart instanceof pvc.PieChart){return 10/7}return 5/4},_getExtensionId:function(){return'content'},_createCore:function(li){var mi=this._multiInfo;if(!mi){return}var chart=this.chart;var options=chart.options;var smallMargins=options.smallMargins;if(smallMargins==null){smallMargins=new pvc.Sides(new pvc.PercentValue(0.02))}else{smallMargins=new pvc.Sides(smallMargins)}var smallPaddings=new pvc.Sides(options.smallPaddings);chart.children.forEach(function(childChart){childChart._setSmallLayout({left:childChart.smallColIndex*li.width,top:childChart.smallRowIndex*li.height,width:li.width,height:li.height,margins:this._buildSmallMargins(childChart,smallMargins),paddings:smallPaddings})},this);var coordScopesByType=mi.coordScopesByType;if(coordScopesByType){chart._coordinateSmallChartsLayout(coordScopesByType)}this.base(li)},_buildSmallMargins:function(childChart,smallMargins){var mi=this._multiInfo;var lastColIndex=mi.colCount-1;var lastRowIndex=mi.rowCount-1;var colIndex=childChart.smallColIndex;var rowIndex=childChart.smallRowIndex;var margins={};if(colIndex>0){margins.left=smallMargins.left}if(colIndex<lastColIndex){margins.right=smallMargins.right}if(rowIndex>0){margins.top=smallMargins.top}if(rowIndex<lastRowIndex){margins.bottom=smallMargins.bottom}return margins}});