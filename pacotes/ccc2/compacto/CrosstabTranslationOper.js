def.type('pvc.data.CrosstabTranslationOper',pvc.data.MatrixTranslationOper).add({virtualItemSize:function(){return this.R+this.C+this.M},_executeCore:function(){if(!this.metadata.length){return def.query()}var dimsReaders=this._getDimensionsReaders();var item=new Array(this.virtualItemSize()),itemCrossGroupIndex=this._itemCrossGroupIndex,me=this;function updateVItemCrossGroup(crossGroupId,source){var itemIndex=itemCrossGroupIndex[crossGroupId],sourceIndex=0,depth=me[crossGroupId];while((depth--)>0){item[itemIndex++]=source[sourceIndex++]}}function updateVItemMeasure(line,cg){var itemIndex=itemCrossGroupIndex.M;var cgIndexes=me._colGroupsIndexes[cg];var depth=me.M;for(var i=0;i<depth;i++){var lineIndex=cgIndexes[i];item[itemIndex++]=lineIndex!=null?line[lineIndex]:null}}function expandLine(line){updateVItemCrossGroup('R',line);return def.query(this._colGroups).select(function(colGroup,cg){updateVItemCrossGroup('C',colGroup);updateVItemMeasure(line,cg);return this._readItem(item,dimsReaders)},this)}return def.query(this._lines).selectMany(expandLine,this)},_processMetadata:function(){this.base();this._separator=this.options.separator||'~';var lines=pvc.cloneMatrix(this.source);this._lines=lines;this.R=1;this.C=1;this.M=1;this.measuresDirection=null;var colNames;if(this.options.seriesInRows){colNames=this.metadata.map(function(d){return d.colName})}else if(this.options.compatVersion<=1){colNames=this.metadata.map(function(d){return{v:d.colName}})}else{colNames=this.metadata.map(function(d){return{v:d.colName,f:d.colLabel}})}var itemCrossGroupTypes=this._itemCrossGroupTypes={};if(!this.options.isMultiValued){this.R=this._getCategoriesCount();this._colGroups=colNames.slice(this.R);this._colGroupsIndexes=new Array(this._colGroups.length);this._colGroups.forEach(function(colGroup,cg){this._colGroups[cg]=[colGroup];this._colGroupsIndexes[cg]=[this.R+cg]},this);itemCrossGroupTypes.C=[0];itemCrossGroupTypes.M=[this._columnTypes[this.R]]}else{var measuresInColumns=def.get(this.options,'measuresInColumns',true);if(measuresInColumns||this.options.measuresIndex==null){this.R=this._getCategoriesCount();var encodedColGroups=colNames.slice(this.R);var L=encodedColGroups.length;if(L>0){if(!measuresInColumns){this._colGroups=encodedColGroups;this._colGroupsIndexes=[];this._colGroups.forEach(function(colGroup,cg){this._colGroups[cg]=this._splitEncodedColGroupCell(colGroup);this._colGroupsIndexes[cg]=[this.R+cg]},this);itemCrossGroupTypes.M=[this._columnTypes[this.R]]}else{this.measuresDirection='columns';this._processEncodedColGroups(encodedColGroups)}this.C=this._colGroups[0].length;itemCrossGroupTypes.C=def.array.create(this.C,0)}else{this.C=this.M=0;itemCrossGroupTypes.M=itemCrossGroupTypes.C=[]}}else{this.measuresDirection='rows';this.R=+this.options.measuresIndex;var measuresCount=this.options.measuresCount;if(measuresCount==null){measuresCount=1}this.M=measuresCount;this._colGroups=colNames.slice(this.R+1);this._colGroups.forEach(function(colGroup,cg){this._colGroups[cg]=[colGroup]},this)}}itemCrossGroupTypes.R=this._columnTypes.slice(0,this.R);var seriesInRows=this.options.seriesInRows;var itemGroupIndex=this._itemCrossGroupIndex={'C':!seriesInRows?0:this.R,'R':!seriesInRows?this.C:0,'M':this.C+this.R};var itemTypes=this._itemTypes=new Array(this.virtualItemSize());def.eachOwn(itemGroupIndex,function(groupStartIndex,crossGroup){itemCrossGroupTypes[crossGroup].forEach(function(type,groupIndex){itemTypes[groupStartIndex+groupIndex]=type})});this._itemLogicalGroup={'series':seriesInRows?this.R:this.C,'category':seriesInRows?this.C:this.R,'value':this.M};this._itemLogicalGroupIndex={'series':0,'category':this._itemLogicalGroup.series,'value':this.C+this.R};if(pvc.debug>=3){pvc.log("Crosstab translator "+pvc.stringify({R:this.R,C:this.C,M:this.M}))}},_getCategoriesCount:function(){var R=this.options.categoriesCount;if(R!=null&&(!isFinite(R)||R<0)){R=null}if(R==null){R=def.query(this._columnTypes).whayl(function(type){return type===0}).count();if(!R){R=1}}return R},_splitEncodedColGroupCell:function(colGroup){var values=colGroup.v;var labels;if(values==null){values=[]}else{values=values.split(this._separator);labels=colGroup.f;if(labels){labels=labels.split(this._separator)}}return values.map(function(value,index){return{v:value,f:labels&&labels[index]}})},_processEncodedColGroups:function(encodedColGroups){var L=encodedColGroups.length||def.assert("Must have columns"),R=this.R,colGroups=[],currColGroup,measuresInfo={},measuresInfoList=[];for(var i=0;i<L;i++){var colGroupCell=encodedColGroups[i];var encColGroupValues=colGroupCell.v;var encColGroupLabels=colGroupCell.f;var sepIndex=encColGroupValues.lastIndexOf(this._separator);var meaName,colGroupValues,colGroupLabels;if(sepIndex<0){meaName=encColGroupValues;encColGroupValues='';colGroupValues=[]}else{meaName=encColGroupValues.substring(sepIndex+1);encColGroupValues=encColGroupValues.substring(0,sepIndex);colGroupValues=encColGroupValues.split(this._separator);if(encColGroupLabels!=null){colGroupLabels=encColGroupLabels.split(this._separator);colGroupLabels.pop()}colGroupValues.forEach(function(value,index){var label=colGroupLabels&&colGroupLabels[index];colGroupValues[index]={v:value,f:label}})}if(!currColGroup||currColGroup.encValues!==encColGroupValues){currColGroup={startIndex:i,encValues:encColGroupValues,values:colGroupValues,measureNames:[meaName]};colGroups.push(currColGroup)}else{currColGroup.measureNames.push(meaName)}var currMeaIndex=(i-currColGroup.startIndex),meaInfo=def.getOwn(measuresInfo,meaName);if(!meaInfo){measuresInfo[meaName]=meaInfo={name:meaName,groupIndex:currMeaIndex,index:i,type:this._columnTypes[R+i]};measuresInfoList.push(meaInfo)}else if(currMeaIndex>meaInfo.groupIndex){meaInfo.groupIndex=currMeaIndex}}measuresInfoList.sort(function(meaInfoA,meaInfoB){return def.compare(meaInfoA.groupIndex,meaInfoB.groupIndex)||def.compare(meaInfoA.index,meaInfoB.index)});var M=measuresInfoList.length;var meaTypes=new Array(M);this._itemCrossGroupTypes.M=meaTypes;measuresInfoList.forEach(function(meaInfoA,index){meaInfoA.groupIndex=index;meaTypes[index]=meaInfoA.type});var CG=colGroups.length,colGroupsValues=new Array(CG),colGroupsIndexes=new Array(CG);colGroups.map(function(colGroup,cg){colGroupsValues[cg]=colGroup.values;var colGroupStartIndex=colGroup.startIndex;var meaIndexes=colGroupsIndexes[cg]=new Array(M);colGroup.measureNames.forEach(function(meaName2,localMeaIndex){var meaIndex=measuresInfo[meaName2].groupIndex;meaIndexes[meaIndex]=R+colGroupStartIndex+localMeaIndex})});this._colGroups=colGroupsValues;this._colGroupsIndexes=colGroupsIndexes;this.M=M},configureType:function(){if(this.measuresDirection==='rows'){throw def.error.notImplemented()}this.base()},_configureTypeCore:function(){var me=this;var itemLogicalGroup=me._itemLogicalGroup;var itemLogicalGroupIndex=me._itemLogicalGroupIndex;var index=0;var dimsReaders=[];function add(dimGroupName,level,count){var crossEndIndex=itemLogicalGroupIndex[dimGroupName]+count;while(count>0){var dimName=pvc.buildIndexedId(dimGroupName,level);if(!me.complexTypeProj.isReadOrCalc(dimName)){index=me._nextAvailableItemIndex(index);if(index>=crossEndIndex){return}dimsReaders.push({names:dimName,indexes:index});index++;count--}level++}}var dataPartDimName=this.options.dataPartDimName;if(dataPartDimName&&this.C===1&&!this.complexTypeProj.isReadOrCalc(dataPartDimName)){var plot2SeriesIndexes=this.options.plot2SeriesIndexes;if(plot2SeriesIndexes!=null){var seriesKeys=this._colGroups.map(function(colGroup){return''+colGroup[0].v});this._plot2SeriesKeySet=this._createPlot2SeriesKeySet(plot2SeriesIndexes,seriesKeys)}}['series','category','value'].forEach(function(dimGroupName){var L=itemLogicalGroup[dimGroupName];if(L>0){add(dimGroupName,0,L)}});if(dimsReaders){dimsReaders.forEach(this.defReader,this)}if(this._plot2SeriesKeySet){var seriesReader=this._userDimsReadersByDim.series;if(seriesReader){var calcAxis2SeriesKeySet=def.fun.constant(this._plot2SeriesKeySet);this._userRead(this._dataPartGet(calcAxis2SeriesKeySet,seriesReader),dataPartDimName)}}}});