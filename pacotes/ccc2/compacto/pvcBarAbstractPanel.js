def.type('pvc.BarAbstractPanel',pvc.CategoricalAbstractPanel).add({pvBar:null,pvBarLabel:null,pvCategoryPanel:null,pvSecondLine:null,pvSecondDot:null,_creating:function(){var groupScene=this.defaultVisibleBulletGroupScene();if(groupScene&&!groupScene.hasRenderer()){var colorAxis=groupScene.colorAxis;var drawLine=colorAxis.option('LegendDrawLine');var drawMarker=!drawLine||colorAxis.option('LegendDrawMarker');if(drawMarker){var keyArgs={drawMarker:true,markerShape:colorAxis.option('LegendShape'),drawRule:drawLine,markerPvProto:new pv.Mark()};this.extend(keyArgs.markerPvProto,'',{constOnly:true});groupScene.renderer(new pvc.visual.legend.BulletItemDefaultRenderer(keyArgs))}}},_createCore:function(){this.base();var me=this,chart=me.chart,plot=me.plot,isStacked=!!me.stacked,isVertical=me.isOrientationVertical(),data=me.visibleData(),seriesData=me.visualRoles.series.flatten(data),rootScene=me._buildScene(data,seriesData),orthoAxis=me.axes.ortho,baseAxis=me.axes.base,orthoScale=orthoAxis.scale,orthoZero=orthoScale(0),sceneOrthoScale=orthoAxis.sceneScale({sceneVarName:'value',nullToZero:false}),sceneBaseScale=baseAxis.sceneScale({sceneVarName:'category'}),barSizeRatio=plot.option('BarSizeRatio'),barSizeMax=plot.option('BarSizeMax'),barStackedMargin=plot.option('BarStackedMargin'),baseRange=baseAxis.scale.range(),bandWidth=baseRange.band,barStepWidth=baseRange.step,barWidth,reverseSeries=isVertical===isStacked;if(isStacked){barWidth=bandWidth}else{var S=seriesData.childCount();barWidth=S>0?(bandWidth*barSizeRatio/S):0}if(barWidth>barSizeMax){barWidth=barSizeMax}me.barWidth=barWidth;me.barStepWidth=barStepWidth;var wrapper;if(me.compatVersion()<=1){wrapper=function(v1f){return function(scene){var markParent=Object.create(this.parent);var mark=Object.create(this);mark.parent=markParent;var serIndex=scene.parent.childIndex();var catIndex=scene.childIndex();if(isStacked){markParent.index=serIndex;mark.index=catIndex}else{markParent.index=catIndex;mark.index=serIndex}return v1f.call(mark,scene.vars.value.rawValue)}}}me.pvBarPanel=new pvc.visual.Panel(me,me.pvPanel,{panelType:pv.Layout.Band,extensionId:'panel'}).lock('layers',rootScene.childNodes).lockMark('values',function(seriesScene){return seriesScene.childNodes}).lockMark('orient',isVertical?'bottom-left':'left-bottom').lockMark('layout',isStacked?'stacked':'grouped').lockMark('verticalMode',me._barVerticalMode()).lockMark('yZero',orthoZero).pvMark.band.x(sceneBaseScale).w(bandWidth).differentialControl(me._barDifferentialControl()).item.order(reverseSeries?"reverse":null).h(function(scene){var y=sceneOrthoScale(scene);return y!=null?chart.animate(0,y-orthoZero):null}).w(barWidth).horizontalRatio(barSizeRatio).verticalMargin(barStackedMargin).end;this.pvBar=new pvc.visual.Bar(me,me.pvBarPanel.item,{extensionId:'',freePosition:true,wrapper:wrapper}).lockDimensions().pvMark.antialias(false);if(plot.option('OverflowMarkersVisible')){this._addOverflowMarkers(wrapper)}if(me.valuesVisible){me.pvBarLabel=new pvc.visual.Label(me,me.pvBar.anchor(me.valuesAnchor||'center'),{extensionId:'label',wrapper:wrapper}).pvMark.visible(function(){var length=this.scene.target[this.index][isVertical?'height':'width'];return length>=4}).font(me.valuesFont).text(function(scene){return scene.format(me.valuesMask)})}},_barVerticalMode:function(){return null},_barDifferentialControl:function(){return null},_getV1Datum:function(scene){var datum=scene.datum;if(datum){var datumEx=Object.create(datum);datumEx.percent=scene.vars.value.percent;datum=datumEx}return datum},_addOverflowMarkers:function(wrapper){var orthoAxis=this.axes.ortho;if(orthoAxis.option('FixedMax')!=null){this.pvOverflowMarker=this._addOverflowMarker(false,orthoAxis.scale,wrapper)}if(orthoAxis.option('FixedMin')!=null){this.pvUnderflowMarker=this._addOverflowMarker(true,orthoAxis.scale,wrapper)}},_addOverflowMarker:function(isMin,orthoScale,wrapper){var isVertical=this.isOrientationVertical(),a_bottom=isVertical?"bottom":"left",a_top=this.anchorOpposite(a_bottom),a_height=this.anchorOrthoLength(a_bottom),a_width=this.anchorLength(a_bottom),paddings=this._layoutInfo.paddings,rOrthoBound=isMin?(orthoScale.min-paddings[a_bottom]):(orthoScale.max+paddings[a_top]),angle;if(!isMin){angle=isVertical?Math.PI:-Math.PI/2}else{angle=isVertical?0:Math.PI/2}return new pvc.visual.Dot(this,this.pvBar.anchor('center'),{noSelect:true,noHover:true,noClick:true,noDoubleClick:true,noTooltip:true,freePosition:true,extensionId:isMin?'underflowMarker':'overflowMarker',wrapper:wrapper}).intercept('visible',function(scene){var visible=this.delegateExtension();if(visible!==undefined&&!visible){return false}var value=scene.vars.value.value;if(value==null){return false}var targetInstance=this.pvMark.scene.target[this.index];var orthoMaxPos=targetInstance[a_bottom]+(value>0?targetInstance[a_height]:0);return isMin?(orthoMaxPos<rOrthoBound):(orthoMaxPos>rOrthoBound)}).lock(a_top,null).lock('shapeSize').pvMark.shape("triangle").shapeRadius(function(){return Math.min(Math.sqrt(10),this.scene.target[this.index][a_width]/2)}).shapeAngle(angle).lineWidth(1.5).strokeStyle("red").fillStyle("white")[a_bottom](function(){return rOrthoBound+(isMin?1:-1)*(this.shapeRadius()+2)})},renderInteractive:function(){this.pvPanel.render()},_getSelectableMarks:function(){return[this.pvBar]},_buildScene:function(data,seriesData){var rootScene=new pvc.visual.Scene(null,{panel:this,group:data});var categDatas=data._children;var roles=this.visualRoles;var valueVarHelper=new pvc.visual.RoleVarHelper(rootScene,roles.value,{hasPercentSubVar:this.stacked});var colorVarHelper=new pvc.visual.RoleVarHelper(rootScene,roles.color);seriesData.children().each(createSeriesScene);return rootScene;function createSeriesScene(seriesData1){var seriesScene=new pvc.visual.Scene(rootScene,{group:seriesData1}),seriesKey=seriesData1.key;seriesScene.vars.series=pvc.visual.ValueLabelVar.fromComplex(seriesData1);colorVarHelper.onNewScene(seriesScene,false);categDatas.forEach(function(categData1){var group=data._childrenByKey[categData1.key]._childrenByKey[seriesKey],scene=new pvc.visual.Scene(seriesScene,{group:group});var categVar=scene.vars.category=pvc.visual.ValueLabelVar.fromComplex(categData1);categVar.group=categData1;valueVarHelper.onNewScene(scene,true);colorVarHelper.onNewScene(scene,true)})}}});