def.type('pvc.ParallelCoordinates',pvc.BaseChart).init(function(options){options=options||{};options.dimensions=options.dimensions||{};if(!options.dimensions.value){options.dimensions.value={valueType:null}}this.base(options)}).add({parCoordPanel:null,_preRenderContent:function(contentOptions){this.parCoordPanel=new pvc.ParCoordPanel(this,this.basePanel,def.create(contentOptions,{topRuleOffset:this.options.topRuleOffset,botRuleOffset:this.options.botRuleOffset,leftRuleOffset:this.options.leftRuleOffset,rightRuleOffset:this.options.rightRuleOffset,sortCategorical:this.options.sortCategorical,mapAllDimensions:this.options.mapAllDimensions,numDigits:this.options.numDigits}))},defaults:def.create(pvc.BaseChart.prototype.defaults,{compatVersion:1,topRuleOffset:30,botRuleOffset:30,leftRuleOffset:60,rightRuleOffset:60,sortCategorical:true,mapAllDimensions:true,numDigits:0})});def.type('pvc.ParCoordPanel',pvc.BasePanel).add({anchor:'fill',pvParCoord:null,dimensions:null,dimensionDescr:null,data:null,retrieveData:function(){var data=this.chart.data;var numDigit=this.chart.options.numDigits;this.dimensions=data.getVisibleCategories();var values=data.getValues();var dataRowIndex=data.getVisibleSeriesIndexes();var pCoordIndex=data.getVisibleCategoriesIndexes();var pCoordKeys=data.getCategories();var pCoordMapping=this.chart.options.mapAllDimensions?pCoordIndex.map(function(d){return isNaN(values[d][0])?{categorical:true,len:0,map:[]}:{categorical:false,len:0,map:[],displayValue:[]}}):pCoordIndex.map(function(d){return isNaN(values[d][0])?{categorical:true,len:0,map:[]}:null});var coordMapUpdate=function(i,val){var cMap=pCoordMapping[i];var k=null;if(!cMap.categorical){var keyVal=val.toFixed(numDigit);k=cMap.map[keyVal];if(k==null){k=cMap.len;cMap.len++;cMap.map[keyVal]=k;cMap.displayValue[keyVal]=val}}else{k=cMap.map[val];if(k==null){k=cMap.len;cMap.len++;cMap.map[val]=k}}return k};for(var d in pCoordMapping){if(pCoordMapping.hasOwnProperty(d)&&pCoordMapping[d]&&pCoordMapping[d].categorical){pCoordMapping[d].displayValue=pCoordMapping[d].map}}var i,item,k;if(this.chart.options.sortCategorical||this.chart.options.mapAllDimensions){for(i=0;i<pCoordMapping.length;i++){if(pCoordMapping[i]){for(var col=0;col<values[i].length;col++){coordMapUpdate(i,values[i][col])}var cMap=pCoordMapping[i].map;var sorted=[];for(item in cMap){if(cMap.hasOwnProperty(item)){sorted.push(item)}}sorted.sort();if(pCoordMapping[i].categorical){for(k=0;k<sorted.length;k++){cMap[sorted[k]]=k}}else{for(k=0;k<sorted.length;k++){cMap[sorted[k]].index=k}}}}}var generateHashMap=function(col){var record={};for(var j in pCoordIndex){if(pCoordIndex.hasOwnProperty(j)){record[pCoordKeys[j]]=(pCoordMapping[j])?coordMapUpdate(j,values[j][col]):values[j][col]}}return record};this.data=dataRowIndex.map(function(col){return generateHashMap(col)});var descrVals=this.dimensions.map(function(cat){var item2={};var elements=cat.split("__");item2.id=cat;item2.name=elements[0];item2.unit=(elements.length>1)?elements[1]:"";return item2});for(i=0;i<descrVals.length;i++){item=descrVals[i];var index=pCoordIndex[i];item.orgRowIndex=index;var len=values[index].length;var theMin,theMax,theMin2,theMax2;var v;if(pCoordMapping[index]){theMin=theMax=theMin2=theMax2=pCoordMapping[index].displayValue[values[index][0]];for(k=1;k<len;k++){v=pCoordMapping[index].displayValue[values[index][k]];if(v<theMin){theMin2=theMin;theMin=v}if(v>theMax){theMax2=theMax;theMax=v}}}else{theMin=theMax=theMin2=theMax2=values[index][0];for(k=1;k<len;k++){v=values[index][k];if(v<theMin){theMin2=theMin;theMin=v}if(v>theMax){theMax2=theMax;theMax=v}}}var theStep=((theMax-theMax2)+(theMin2-theMin))/2;item.min=theMin;item.max=theMax;item.step=theStep;item.categorical=false;if(pCoordMapping[index]){item.map=pCoordMapping[index].map;item.mapLength=pCoordMapping[index].len;item.categorical=pCoordMapping[index].categorical;if(!item.categorical){item.orgValue=[];var theMap=pCoordMapping[index].map;for(var key in theMap){if(theMap.hasOwnProperty(key)){item.orgValue[theMap[key]]=0.0+key}}}}}var genKeyVal=function(keys,vals){var record={};for(var i=0;i<keys.length;i++){record[keys[i]]=vals[i]}return record};this.dimensionDescr=genKeyVal(this.dimensions,descrVals)},_createCore:function(){var myself=this;this.retrieveData();var height=this.height,numDigits=this.chart.options.numDigits,topRuleOffs=this.chart.options.topRuleOffset,botRuleOffs=this.chart.options.botRuleOffset,leftRuleOffs=this.chart.options.leftRuleOffset,rightRulePos=this.width-this.chart.options.rightRuleOffset,topRulePos=this.height-topRuleOffs,ruleHeight=topRulePos-botRuleOffs,labelTopOffs=topRuleOffs-12,dims=this.dimensions,dimDescr=this.dimensionDescr;var getDimSc=function(t,addMargin){var theMin=dimDescr[t].min;var theMax=dimDescr[t].max;var theStep=dimDescr[t].step;if(addMargin){theMin-=theStep;theMax+=theStep}return pv.Scale.linear(theMin,theMax).range(botRuleOffs,topRulePos)};var getDimensionScale=function(t){var scale=getDimSc(t,true).range(botRuleOffs,topRulePos);var dd=dimDescr[t];if(dd.orgValue&&!dd.categorical){var func=function(x){var res=scale(dd.orgValue[x]);return res};func.domain=function(){return scale.domain()};func.invert=function(d){return scale.invert(d)};return func}return scale};var getDimColorScale=function(t){var scale=getDimSc(t,false).range("steelblue","brown");return scale};var x=pv.Scale.ordinal(dims).splitFlush(leftRuleOffs,rightRulePos);var y=pv.dict(dims,getDimensionScale);var colors=pv.dict(dims,getDimColorScale);var filter=pv.dict(dims,function(t){return{min:y[t].domain()[0],max:y[t].domain()[1]}});var active=dims[0];var selectVisible=this.chart.options.mapAllDimensions?function(d){return dims.every(function(t){var dd=dimDescr[t];var val=(dd.orgValue&&!dd.categorical)?dd.orgValue[d[t]]:d[t];return(val>=filter[t].min)&&(val<=filter[t].max)})}:function(d){return dims.every(function(t){return(d[t]>=filter[t].min)&&(d[t]<=filter[t].max)})};var auxData=null;this.pvParCoord=this.pvPanel.add(pv.Panel).data(myself.data).visible(selectVisible).add(pv.Line).data(dims).left(function(t,d){return x(t)}).bottom(function(t,d){var res=y[t](d[t]);return res}).strokeStyle("#ddd").lineWidth(1).antialias(false);var rule=this.pvPanel.add(pv.Rule).data(dims).left(x).top(topRuleOffs).bottom(botRuleOffs);rule.anchor("top").add(pv.Label).top(labelTopOffs).font("bold 10px sans-serif").text(function(d){return dimDescr[d].name});var labels=[];var labelXoffs=6,labelYoffs=3;for(var d in dimDescr){if(dimDescr.hasOwnProperty(d)){var dim=dimDescr[d];if(dim.categorical){var xVal=x(dim.id)+labelXoffs;for(var l in dim.map){if(dim.map.hasOwnProperty(l)){labels[labels.length]={x:xVal,y:y[dim.id](dim.map[l])+labelYoffs,label:l}}}}}}var dimLabels=this.pvPanel.add(pv.Panel).data(labels).add(pv.Label).left(function(d){return d.x}).bottom(function(d){return d.y}).text(function(d){return d.label}).textAlign("left");var change=this.pvPanel.add(pv.Panel);var line=change.add(pv.Panel).data(myself.data).visible(selectVisible).add(pv.Line).data(dims).left(function(t,d){return x(t)}).bottom(function(t,d){return y[t](d[t])}).strokeStyle(function(t,d){var dd=dimDescr[active];var val=(dd.orgValue&&!dd.categorical)?dd.orgValue[d[active]]:d[active];return colors[active](val)}).lineWidth(1);function update(d){var t=d.dim;filter[t].min=Math.max(y[t].domain()[0],y[t].invert(height-d.y-d.dy));filter[t].max=Math.min(y[t].domain()[1],y[t].invert(height-d.y));active=t;change.render();return false}function selectAll(d){if(d.dy<3){var t=d.dim;filter[t].min=Math.max(y[t].domain()[0],y[t].invert(0));filter[t].max=Math.min(y[t].domain()[1],y[t].invert(height));d.y=botRuleOffs;d.dy=ruleHeight;active=t;change.render()}return false}var handle=change.add(pv.Panel).data(dims.map(function(dim){return{y:botRuleOffs,dy:ruleHeight,dim:dim}})).left(function(t){return x(t.dim)-30}).width(60).fillStyle("rgba(0,0,0,.001)").cursor("crosshair").event("mousedown",pv.Behavior.select()).event("select",update).event("selectend",selectAll).add(pv.Bar).left(25).top(function(d){return d.y}).width(10).height(function(d){return d.dy}).fillStyle(function(t){return(t.dim==active)?colors[t.dim]((filter[t.dim].max+filter[t.dim].min)/2):"hsla(0,0,50%,.5)"}).strokeStyle("white").cursor("move").event("mousedown",pv.Behavior.drag()).event("dragstart",update).event("drag",update);handle.anchor("bottom").add(pv.Label).textBaseline("top").text(function(d){return(dimDescr[d.dim].categorical)?"":filter[d.dim].min.toFixed(numDigits)+dimDescr[d.dim].unit});handle.anchor("top").add(pv.Label).textBaseline("bottom").text(function(d){return(dimDescr[d.dim].categorical)?"":filter[d.dim].max.toFixed(numDigits)+dimDescr[d.dim].unit});this.extend(this.pvParCoord,"parCoord");this.extend(this.pvPanel,"chart")}});