def.type('pvc.MetricPointPanel',pvc.CartesianAbstractPanel).init(function(chart,parent,plot,options){this.base(chart,parent,plot,options);this.axes.size=chart._getAxis('size',(plot.option('SizeAxis')||0)-1);var sizeRoleName=plot.option('SizeRole');this.visualRoles.size=chart.visualRoles(sizeRoleName);this.linesVisible=plot.option('LinesVisible');this.dotsVisible=plot.option('DotsVisible');if(!this.linesVisible&&!this.dotsVisible){this.linesVisible=true;plot.option.specify({'LinesVisible':true})}this.dotShape=plot.option('Shape');if(!this.offsetPaddings){this.offsetPaddings=new pvc.Sides(0.01)}}).add({pvLine:null,pvDot:null,pvLabel:null,pvScatterPanel:null,dotShape:"circle",sizeAxisRatio:1/5,sizeAxisRatioTo:'minWidthHeight',autoPaddingByDotSize:true,_v1DimRoleName:{'category':'x','value':'y'},_creating:function(){var groupScene=this.defaultVisibleBulletGroupScene();if(groupScene&&!groupScene.hasRenderer()){var colorAxis=groupScene.colorAxis;var drawMarker=def.nullyTo(colorAxis.option('LegendDrawMarker',true),this.dotsVisible);var drawRule=def.nullyTo(colorAxis.option('LegendDrawLine',true),this.linesVisible);if(drawMarker||drawRule){var keyArgs={};if((keyArgs.drawMarker=drawMarker)){keyArgs.markerShape=colorAxis.option('LegendShape',true)||'circle';keyArgs.markerPvProto=new pv.Dot().lineWidth(1.5,pvc.extensionTag).shapeSize(12,pvc.extensionTag);this.extend(keyArgs.markerPvProto,'dot',{constOnly:true})}if((keyArgs.drawRule=drawRule)){keyArgs.rulePvProto=new pv.Line().lineWidth(1.5,pvc.extensionTag);this.extend(keyArgs.rulePvProto,'line',{constOnly:true})}groupScene.renderer(new pvc.visual.legend.BulletItemDefaultRenderer(keyArgs))}}},_getRootScene:function(){var me=this;var rootScene=me._rootScene;if(!rootScene){var roles=me.visualRoles;var hasColorRole=roles.color.isBound()&&!me.axes.color.scale.isNull;var hasSizeRole=roles.size.isBound()&&!me.axes.size.scale.isNull;me._rootScene=rootScene=me._buildScene(hasColorRole,hasSizeRole)}return rootScene},_calcLayout:function(layoutInfo){var rootScene=this._getRootScene();if(rootScene.hasSizeRole){var areaRange=this._calcDotAreaRange(layoutInfo);this.sizeScale=this.axes.size.setScaleRange(areaRange).scale}this._calcAxesPadding(layoutInfo,rootScene)},_getDotDiameterRefLength:function(layoutInfo){var clientSize=layoutInfo.clientSize;var paddings=layoutInfo.paddings;switch(this.sizeAxisRatioTo){case'minWidthHeight':return Math.min(clientSize.width+paddings.width,clientSize.height+paddings.height);case'width':return clientSize.width+paddings.width;case'height':return clientSize.height+paddings.height}if(pvc.debug>=2){this._log(def.format("Invalid option 'sizeAxisRatioTo' value. Assuming 'minWidthHeight'.",[this.sizeAxisRatioTo]))}this.sizeRatioTo='minWidthHeight';return this._getDotDiameterRefLength(layoutInfo)},_calcDotRadiusRange:function(layoutInfo){var refLength=this._getDotDiameterRefLength(layoutInfo);var max=(this.sizeAxisRatio/2)*refLength;var min=Math.sqrt(12);return{min:min,max:max}},_calcDotAreaRange:function(layoutInfo){var radiusRange=this._calcDotRadiusRange(layoutInfo);if(this.dotShape==='diamond'){radiusRange.max/=Math.SQRT2;radiusRange.min/=Math.SQRT2}var maxArea=radiusRange.max*radiusRange.max,minArea=radiusRange.min*radiusRange.min,areaSpan=maxArea-minArea;if(areaSpan<=1){maxArea=Math.max(maxArea,2);minArea=1;areaSpan=maxArea-minArea;radiusRange={min:Math.sqrt(minArea),max:Math.sqrt(maxArea)};if(pvc.debug>=3){this._log("Using rescue mode dot area calculation due to insufficient space.")}}return{min:minArea,max:maxArea,span:areaSpan}},_calcAxesPadding:function(layoutInfo,rootScene){var requestPaddings;if(!this.autoPaddingByDotSize){requestPaddings=this._calcRequestPaddings(layoutInfo)}else{var axes=this.axes;var clientSize=layoutInfo.clientSize;var paddings=layoutInfo.paddings;requestPaddings={};axes.x.setScaleRange(clientSize.width);axes.y.setScaleRange(clientSize.height);var sceneXScale=axes.base.sceneScale({sceneVarName:'x'});var sceneYScale=axes.ortho.sceneScale({sceneVarName:'y'});var xLength=axes.base.scale.max;var yLength=axes.ortho.scale.max;var hasSizeRole=rootScene.hasSizeRole;var sizeScale=this.sizeScale;if(!hasSizeRole){var defaultSize=def.number.as(this._getExtension('dot','shapeRadius'),0);if(defaultSize<=0){defaultSize=def.number.as(this._getExtension('dot','shapeSize'),0);if(defaultSize<=0){defaultSize=12}}else{defaultSize=defaultSize*defaultSize}sizeScale=def.fun.constant(defaultSize)}requestPaddings={};var op;if(this.offsetPaddings){op={};pvc.Sides.names.forEach(function(side){var len_a=pvc.BasePanel.orthogonalLength[side];op[side]=(this.offsetPaddings[side]||0)*(clientSize[len_a]+paddings[len_a])},this)}var setSide=function(side,padding){if(op){padding+=(op[side]||0)}if(padding<0){padding=0}var value=requestPaddings[side];if(value==null||padding>value){requestPaddings[side]=padding}};var processScene=function(scene){var x=sceneXScale(scene);var y=sceneYScale(scene);var r=Math.sqrt(sizeScale(hasSizeRole?scene.vars.size.value:0));setSide('left',r-x);setSide('bottom',r-y);setSide('right',x+r-xLength);setSide('top',y+r-yLength)};rootScene.children().selectMany(function(seriesScene){return seriesScene.childNodes}).each(processScene)}layoutInfo.requestPaddings=requestPaddings},_createCore:function(){this.base();var myself=this;var chart=this.chart;var rootScene=this._getRootScene();this._finalizeScene(rootScene);this.pvPanel.zOrder(1);this.pvScatterPanel=new pvc.visual.Panel(this,this.pvPanel,{extensionId:'panel'}).lock('data',rootScene.childNodes).pvMark;var wrapper;if(this.compatVersion()<=1){wrapper=function(v1f){return function(dotScene){var d={category:dotScene.vars.x.rawValue,value:dotScene.vars.y.rawValue};var pseudo=Object.create(this);pseudo.index=dotScene.dataIndex;return v1f.call(pseudo,d)}}}var isLineNoSelect=chart._canSelectWithFocusWindow();var line=new pvc.visual.Line(this,this.pvScatterPanel,{extensionId:'line',wrapper:wrapper,noTooltip:false,noHover:true,noSelect:isLineNoSelect,showsSelection:!isLineNoSelect}).lock('data',function(seriesScene){return seriesScene.childNodes}).lock('visible',this.linesVisible).override('x',function(){return this.scene.basePosition}).override('y',function(){return this.scene.orthoPosition});this.pvLine=line.pvMark;var dot=new pvc.visual.Dot(this,this.pvLine,{extensionId:'dot',wrapper:wrapper,activeSeriesAware:this.linesVisible}).intercept('visible',function(){return!this.scene.isIntermediate&&this.delegateExtension(true)}).lock('shape',this.dotShape).override('x',function(){return this.scene.basePosition}).override('y',function(){return this.scene.orthoPosition}).override('color',function(type){if(!myself.dotsVisible){var visible=this.scene.isActive||this.scene.isSingle;if(!visible){return pvc.invisibleFill}}return this.base(type)});this.pvDot=dot.pvMark;this.pvDot.rubberBandSelectionMode='center';dot.override('defaultColor',function(type){var color=this.base(type);if(color&&type==='stroke'){color=color.darker()}return color}).override('interactiveColor',function(color,type){if(type==='stroke'&&this.scene.isActive){return color}return this.base(color,type)});if(!rootScene.hasSizeRole){dot.override('baseSize',function(){if(!myself.dotsVisible){if(this.scene.isSingle){var lineWidth=Math.max(myself.pvLine.scene[this.pvMark.index].lineWidth,0.2)/2;return lineWidth*lineWidth}}return this.base()})}else{var sizeAxis=myself.axes.size;if(sizeAxis.scaleUsesAbs()){dot.override('strokeColor',function(){return this.scene.vars.size.value<0?"#000000":this.base()}).optional('lineCap','round').optionalMark('strokeDasharray',function(scene){return scene.vars.size.value<0?'dot':null}).optionalMark('lineWidth',function(scene){return scene.vars.size.value<0?1.8:1.5})}var sizeScale=this.sizeScale;dot.override('baseSize',function(){return sizeScale(this.scene.vars.size.value)}).override('interactiveSize',function(size){if(this.scene.isActive){var radius=Math.sqrt(size)*1.1;return radius*radius}return size});this.pvPanel.borderPanel.overflow("hidden")}if(this.valuesVisible){var extensionIds=['label'];if(this.compatVersion()<=1){extensionIds.push('lineLabel')}this.pvLabel=new pvc.visual.Label(this,this.pvDot.anchor(this.valuesAnchor),{extensionId:extensionIds,wrapper:wrapper}).pvMark.font(this.valuesFont).text(function(scene){return def.string.join(",",scene.vars.x.label,scene.vars.y.label)})}},renderInteractive:function(){this.pvScatterPanel.render()},_getSelectableMarks:function(){var marks=[];marks.push(this.pvDot);if(this.linesVisible){marks.push(this.pvLine)}return marks},_finalizeScene:function(rootScene){var axes=this.axes,sceneBaseScale=axes.base.sceneScale({sceneVarName:'x'}),sceneOrthoScale=axes.ortho.sceneScale({sceneVarName:'y'});rootScene.children().selectMany(function(seriesScene){return seriesScene.childNodes}).each(function(leafScene){leafScene.basePosition=sceneBaseScale(leafScene);leafScene.orthoPosition=sceneOrthoScale(leafScene)});return rootScene},_buildScene:function(hasColorRole,hasSizeRole){var data=this.visibleData();var rootScene=new pvc.visual.Scene(null,{panel:this,group:data});rootScene.hasColorRole=hasColorRole;rootScene.hasSizeRole=hasSizeRole;var roles=this.visualRoles;var colorVarHelper=new pvc.visual.RoleVarHelper(rootScene,roles.color,{forceUnbound:!hasColorRole});var sizeVarHelper=new pvc.visual.RoleVarHelper(rootScene,roles.size,{forceUnbound:!hasSizeRole});var xDim=data.owner.dimensions(roles.x.firstDimensionName());var yDim=data.owner.dimensions(roles.y.firstDimensionName());data.children().each(createSeriesScene,this);rootScene.children().each(completeSeriesScenes,this);return rootScene;function createSeriesScene(seriesGroup){var seriesScene=new pvc.visual.Scene(rootScene,{group:seriesGroup});seriesScene.vars.series=pvc.visual.ValueLabelVar.fromComplex(seriesGroup);colorVarHelper.onNewScene(seriesScene,false);seriesGroup.datums().each(function(datum,dataIndex){var xAtom=datum.atoms[xDim.name];if(xAtom.value==null){return}var yAtom=datum.atoms[yDim.name];if(yAtom.value==null){return}var scene=new pvc.visual.Scene(seriesScene,{datum:datum});scene.dataIndex=dataIndex;scene.vars.x=Object.create(xAtom);scene.vars.y=Object.create(yAtom);sizeVarHelper.onNewScene(scene,true);colorVarHelper.onNewScene(scene,true);scene.isIntermediate=false})}function completeSeriesScenes(seriesScene){var seriesScenes=seriesScene.childNodes,fromScene;for(var c=0,toChildIndex=0,pointCount=seriesScenes.length;c<pointCount;c++,toChildIndex++){var toScene=seriesScenes[toChildIndex];toScene.isSingle=!fromScene&&!toScene.nextSibling;if(fromScene){var interScene=createIntermediateScene(seriesScene,fromScene,toScene,toChildIndex);if(interScene){toChildIndex++}}fromScene=toScene}}function createIntermediateScene(seriesScene,fromScene,toScene,toChildIndex){var interYValue=yDim.type.cast.call(null,((+toScene.vars.y.value)+(+fromScene.vars.y.value))/2);var interXValue=xDim.type.cast.call(null,((+toScene.vars.x.value)+(+fromScene.vars.x.value))/2);var interScene=new pvc.visual.Scene(seriesScene,{index:toChildIndex,datum:toScene.datum});interScene.dataIndex=toScene.dataIndex;interScene.vars.x=new pvc.visual.ValueLabelVar(interXValue,xDim.format(interXValue),interXValue);interScene.vars.y=new pvc.visual.ValueLabelVar(interYValue,yDim.format(interYValue),interYValue);sizeVarHelper.onNewScene(interScene,true);colorVarHelper.onNewScene(interScene,true);interScene.ownerScene=toScene;interScene.isIntermediate=true;interScene.isSingle=false;return interScene}}});