def.type('pvc.AxisPanel',pvc.BasePanel).init(function(chart,parent,axis,options){options=def.create(options,{anchor:axis.option('Position')});var anchor=options.anchor||this.anchor;this.axis=axis;this.base(chart,parent,options);this.roleName=axis.role.name;this.isDiscrete=axis.role.isDiscrete();this._extensionPrefix=axis.extensionPrefixes;if(this.labelSpacingMin==null){this.labelSpacingMin=this.isDiscrete?0.1:1.5}if(this.showTicks==null){this.showTicks=!this.isDiscrete}if(options.font===undefined){var extFont=this._getConstantExtension('label','font');if(extFont){this.font=extFont}}if(options.tickLength===undefined){var tickLength=+this._getConstantExtension('ticks',this.anchorOrthoLength(anchor));if(!isNaN(tickLength)&&isFinite(tickLength)){this.tickLength=tickLength}}}).add({pvRule:null,pvTicks:null,pvLabel:null,pvRuleGrid:null,pvScale:null,isDiscrete:false,roleName:null,axis:null,anchor:"bottom",tickLength:6,scale:null,ruleCrossesMargin:true,font:'9px sans-serif',labelSpacingMin:null,domainRoundMode:'none',desiredTickCount:null,tickExponentMin:null,tickExponentMax:null,showMinorTicks:true,showTicks:null,hiddenLabelText:"\u00B7",_isScaleSetup:false,_createLogInstanceId:function(){return this.base()+" - "+this.axis.id},getTicks:function(){return this._layoutInfo&&this._layoutInfo.ticks},_calcLayout:function(layoutInfo){var scale=this.axis.scale;if(!this._isScaleSetup){this.pvScale=scale;this.scale=scale;this.extend(scale,"scale");this._isScaleSetup=true}if(scale.isNull){layoutInfo.axisSize=0}else{this._calcLayoutCore(layoutInfo)}return this.createAnchoredSize(layoutInfo.axisSize,layoutInfo.clientSize)},_calcLayoutCore:function(layoutInfo){var axisSize=layoutInfo.desiredClientSize[this.anchorOrthoLength()];layoutInfo.axisSize=axisSize;if(this.isDiscrete&&this.useCompositeAxis){if(layoutInfo.axisSize==null){layoutInfo.axisSize=50}}else{layoutInfo.textAngle=def.number.as(this._getExtension('label','textAngle'),0);layoutInfo.textMargin=def.number.as(this._getExtension('label','textMargin'),3);this._calcTicks();if(this.scale.type==='discrete'){this._calcDiscreteTicksHidden()}this._calcAxisSizeFromLabel();if(layoutInfo.axisSize==null){layoutInfo.axisSize=layoutInfo.requiredAxisSize}this._calcMaxTextLengthThatFits();this._calcOverflowPaddings()}},_calcAxisSizeFromLabel:function(){this._calcLabelBBox();this._calcAxisSizeFromLabelBBox()},_calcLabelBBox:function(){var layoutInfo=this._layoutInfo;var align=this._getExtension('label','textAlign');if(typeof align!=='string'){align=this.isAnchorTopOrBottom()?"center":(this.anchor=="left")?"right":"left"}var baseline=this._getExtension('label','textBaseline');if(typeof baseline!=='string'){switch(this.anchor){case"right":case"left":case"center":baseline="middle";break;case"bottom":baseline="top";break;default:baseline="bottom"}}return(layoutInfo.labelBBox=pvc.text.getLabelBBox(layoutInfo.maxTextWidth!=null?layoutInfo.maxTextWidth:layoutInfo._maxTextWidth,layoutInfo.textHeight,align,baseline,layoutInfo.textAngle,layoutInfo.textMargin))},_calcAxisSizeFromLabelBBox:function(){var layoutInfo=this._layoutInfo;var labelBBox=layoutInfo.labelBBox;var length=this._getLabelBBoxQuadrantLength(labelBBox,this.anchor);var axisSize=this.tickLength+length;var angle=labelBBox.sourceAngle;if(!(angle===0&&this.isAnchorTopOrBottom())){axisSize+=this.tickLength}layoutInfo.requiredAxisSize=axisSize},_getLabelBBoxQuadrantLength:function(labelBBox,quadrantSide){var length;switch(quadrantSide){case'left':length=-labelBBox.x;break;case'right':length=labelBBox.x2;break;case'top':length=-labelBBox.y;break;case'bottom':length=labelBBox.y2;break}return Math.max(length,0)},_calcOverflowPaddings:function(){if(!this._layoutInfo.canChange){if(pvc.debug>=2){this._log("[WARNING] Layout cannot change. Skipping calculation of overflow paddings.")}return}if(!this._layoutInfo.labelBBox){this._calcLabelBBox()}this._calcOverflowPaddingsFromLabelBBox()},_calcOverflowPaddingsFromLabelBBox:function(){var overflowPaddings=null;var layoutInfo=this._layoutInfo;var ticks=layoutInfo.ticks;var tickCount=ticks.length;if(tickCount){var paddings=layoutInfo.paddings;var labelBBox=layoutInfo.labelBBox;var isTopOrBottom=this.isAnchorTopOrBottom();var begSide=isTopOrBottom?'left':'top';var endSide=isTopOrBottom?'right':'bottom';var isDiscrete=this.scale.type==='discrete';var clientLength=layoutInfo.clientSize[this.anchorLength()];this.axis.setScaleRange(clientLength);var sideTickOffset;if(isDiscrete){var halfBand=this.scale.range().step/2; sideTickOffset=def.set({},begSide,halfBand,endSide,halfBand)}else{sideTickOffset=def.set({},begSide,this.scale(ticks[0]),endSide,clientLength-this.scale(ticks[tickCount-1]))}[begSide,endSide].forEach(function(side){var overflowPadding=this._getLabelBBoxQuadrantLength(labelBBox,side);if(overflowPadding>0){overflowPadding-=(paddings[side]||0);if(overflowPadding>0){overflowPadding-=sideTickOffset[side];if(overflowPadding>1){if(isDiscrete){overflowPadding*=1.05}if(!overflowPaddings){overflowPaddings={}}overflowPaddings[side]=overflowPadding}}}},this);if(pvc.debug>=6&&overflowPaddings){this._log("OverflowPaddings = "+pvc.stringify(overflowPaddings))}}layoutInfo.overflowPaddings=overflowPaddings},_calcMaxTextLengthThatFits:function(){var layoutInfo=this._layoutInfo;if(this.compatVersion()<=1){layoutInfo.maxTextWidth=null;return}var availableClientLength=layoutInfo.clientSize[this.anchorOrthoLength()];var efSize=Math.min(layoutInfo.axisSize,availableClientLength);if(efSize>=(layoutInfo.requiredAxisSize-this.tickLength)){layoutInfo.maxTextWidth=null}else{var labelBBox=layoutInfo.labelBBox;var maxOrthoLength=efSize-2*this.tickLength;var mostOrthoDistantPoint;var parallelDirection;switch(this.anchor){case'left':parallelDirection=pv.vector(0,1);mostOrthoDistantPoint=pv.vector(-maxOrthoLength,0);break;case'right':parallelDirection=pv.vector(0,1);mostOrthoDistantPoint=pv.vector(maxOrthoLength,0);break;case'top':parallelDirection=pv.vector(1,0);mostOrthoDistantPoint=pv.vector(0,-maxOrthoLength);break;case'bottom':parallelDirection=pv.vector(1,0);mostOrthoDistantPoint=pv.vector(0,maxOrthoLength);break}var orthoOutwardsDir=mostOrthoDistantPoint.norm();var corners=labelBBox.source.points();var botL=corners[0];var botR=corners[1];var topR=corners[2];var topL=corners[3];var topLRSideDir=topR.minus(topL);var botLRSideDir=botR.minus(botL);var intersect=pv.SvgScene.lineIntersect;var botI=intersect(mostOrthoDistantPoint,parallelDirection,botL,botLRSideDir);var topI=intersect(mostOrthoDistantPoint,parallelDirection,topL,topLRSideDir);var sideLRWidth=labelBBox.sourceTextWidth;var maxTextWidth=sideLRWidth;var botLI=botI.minus(botL);var botLILen=botLI.length();if(botLILen<=sideLRWidth&&botLI.dot(topLRSideDir)>=0){if(botL.dot(orthoOutwardsDir)<botR.dot(orthoOutwardsDir)){maxTextWidth=botLILen}else{maxTextWidth=botI.minus(botR).length()}}var topLI=topI.minus(topL);var topLILen=topLI.length();if(topLILen<=sideLRWidth&&topLI.dot(topLRSideDir)>=0){if(topL.dot(orthoOutwardsDir)<topR.dot(orthoOutwardsDir)){maxTextWidth=Math.min(maxTextWidth,topLILen)}else{maxTextWidth=Math.min(maxTextWidth,topI.minus(topR).length())}}if(labelBBox.sourceAlign==='center'){var cutWidth=sideLRWidth-maxTextWidth;maxTextWidth-=cutWidth}layoutInfo.maxTextWidth=maxTextWidth;if(pvc.debug>=3){this._log("Trimming labels' text at length "+maxTextWidth.toFixed(2)+"px maxOrthoLength="+maxOrthoLength.toFixed(2)+"px")}}},_calcTicks:function(){var layoutInfo=this._layoutInfo;layoutInfo.textHeight=pv.Text.fontHeight(this.font);layoutInfo.maxTextWidth=null;this.axis.setTicks(null);switch(this.scale.type){case'discrete':this._calcDiscreteTicks();break;case'timeSeries':this._calcTimeSeriesTicks();break;case'numeric':this._calcNumberTicks(layoutInfo);break;default:throw def.error.operationInvalid("Undefined axis scale type")}this.axis.setTicks(layoutInfo.ticks);var clientLength=layoutInfo.clientSize[this.anchorLength()];this.axis.setScaleRange(clientLength);if(layoutInfo.maxTextWidth==null){layoutInfo.maxTextWidth=def.query(layoutInfo.ticksText).select(function(text){return pv.Text.measure(text,this.font).width},this).max()}layoutInfo._maxTextWidth=layoutInfo.maxTextWidth},_calcDiscreteTicks:function(){var layoutInfo=this._layoutInfo;var role=this.chart.visualRoles(this.roleName);var data=role.flatten(this.chart.data,{visible:true});layoutInfo.data=data;layoutInfo.ticks=data._children;var format,dimType;var grouping=role.grouping;if(grouping.isSingleDimension&&(dimType=grouping.firstDimensionType())&&(dimType.valueType===Date)){var extent=data.dimensions(dimType.name).extent();if(extent&&extent.min!==extent.max){var scale=new pv.Scale.linear(extent.min.value,extent.max.value);scale.ticks();var tickFormatter=this.axis.option('TickFormatter');if(tickFormatter){scale.tickFormatter(tickFormatter)}format=function(child){return scale.tickFormat(child.value)}}}if(!format){format=function(child){return child.absLabel}}layoutInfo.ticksText=data._children.map(format)},_calcTimeSeriesTicks:function(){this._calcContinuousTicks(this._layoutInfo)},_calcNumberTicks:function(){var desiredTickCount=this.desiredTickCount;if(desiredTickCount==null){if(this.isAnchorTopOrBottom()){this._calcNumberHTicks();return}desiredTickCount=this._calcNumberVDesiredTickCount()}this._calcContinuousTicks(this._layoutInfo,desiredTickCount)},_calcContinuousTicks:function(ticksInfo,desiredTickCount){this._calcContinuousTicksValue(ticksInfo,desiredTickCount);this._calcContinuousTicksText(ticksInfo)},_calcContinuousTicksValue:function(ticksInfo,desiredTickCount){ticksInfo.ticks=this.scale.ticks(desiredTickCount,{roundInside:this.domainRoundMode!=='tick',numberExponentMin:this.tickExponentMin,numberExponentMax:this.tickExponentMax});if(pvc.debug>4){this._log("DOMAIN: "+pvc.stringify(this.scale.domain()));this._log("TICKS:  "+pvc.stringify(ticksInfo.ticks))}},_calcContinuousTicksText:function(ticksInfo){ticksInfo.ticksText=def.query(ticksInfo.ticks).select(function(tick){return this.scale.tickFormat(tick)},this).array()},_calcDiscreteTicksHidden:function(){return this._tickIncludeModulo=this._calcDiscreteTicksHiddenCore()},_calcDiscreteTicksHiddenCore:function(){var mode=this.axis.option('OverlappedLabelsMode');if(mode!=='hide'){return 1}var layoutInfo=this._layoutInfo;var ticks=layoutInfo.ticks;var tickCount=ticks.length;if(tickCount<=1){return 1}var b=this.scale.range().step;var h=layoutInfo.textHeight;var w=layoutInfo.maxTextWidth;if(!(w>0&&h>0&&b>0)){return 1}var sMin=h*this.labelSpacingMin;var a=layoutInfo.textAngle;var isTopOrBottom=this.isAnchorTopOrBottom();var sinOrCos=isTopOrBottom?'sin':'cos';var cosOrSin=!isTopOrBottom?'sin':'cos';var tickIncludeModulo=1;do{var bEf=tickIncludeModulo*b;var sBase=bEf*Math.abs(Math[sinOrCos](a))-h;var sOrtho=bEf*Math.abs(Math[cosOrSin](a))-w;if(sBase>=sMin||sOrtho>=sMin){break}tickIncludeModulo++}while(Math.ceil(tickCount/tickIncludeModulo)>1);if(tickIncludeModulo>1&&pvc.debug>=3){this._log("Showing only one in every "+tickIncludeModulo+" tick labels")}return tickIncludeModulo},_calcNumberVDesiredTickCount:function(){var layoutInfo=this._layoutInfo;var lineHeight=layoutInfo.textHeight*(1+Math.max(0,this.labelSpacingMin));var clientLength=layoutInfo.clientSize[this.anchorLength()];return Math.max(1,~~(clientLength/lineHeight))},_calcNumberHTicks:function(){var layoutInfo=this._layoutInfo;var clientLength=layoutInfo.clientSize[this.anchorLength()];var spacing=layoutInfo.textHeight*Math.max(0,this.labelSpacingMin);var desiredTickCount=this._calcNumberHDesiredTickCount(spacing);var doLog=(pvc.debug>=7);var dir,prevResultTickCount;var ticksInfo,lastBelow,lastAbove;do{if(doLog){this._log("calculateNumberHTicks TickCount IN desired = "+desiredTickCount)}ticksInfo={};this._calcContinuousTicksValue(ticksInfo,desiredTickCount);var ticks=ticksInfo.ticks;var resultTickCount=ticks.length;if(ticks.exponentOverflow){if(dir==null){if(ticks.exponent===this.exponentMin){lastBelow=ticksInfo;dir=1}else{lastAbove=ticksInfo;dir=-1}}else if(dir===1){if(lastBelow){ticksInfo=lastBelow}break}else{if(lastAbove){ticksInfo=lastAbove}break}}else if(prevResultTickCount==null||resultTickCount!==prevResultTickCount){if(doLog){this._log("calculateNumberHTicks TickCount desired/resulting = "+desiredTickCount+" -> "+resultTickCount)}prevResultTickCount=resultTickCount;this._calcContinuousTicksText(ticksInfo);var length=this._calcNumberHLength(ticksInfo,spacing);var excessLength=ticksInfo.excessLength=length-clientLength;var pctError=ticksInfo.error=Math.abs(excessLength/clientLength);if(doLog){this._log("calculateNumberHTicks error="+(excessLength>=0?"+":"-")+(ticksInfo.error*100).toFixed(0)+"% count="+resultTickCount+" step="+ticks.step);this._log("calculateNumberHTicks Length client/resulting = "+clientLength+" / "+length+" spacing = "+spacing)}if(excessLength>0){if(desiredTickCount===1){if(resultTickCount===3&&pctError<=1){ticksInfo.ticks.splice(1,1);ticksInfo.ticksText.splice(1,1);ticksInfo.ticks.step*=2}else{ticksInfo.ticks.length=1;ticksInfo.ticksText.length=1}delete ticksInfo.maxTextWidth;break}if(lastBelow){ticksInfo=lastBelow;break}lastAbove=ticksInfo;dir=-1}else{if(pctError<=0.05||dir===-1){break}lastBelow=ticksInfo;dir=+1}}desiredTickCount+=dir}while(true);if(ticksInfo){layoutInfo.ticks=ticksInfo.ticks;layoutInfo.ticksText=ticksInfo.ticksText;layoutInfo.maxTextWidth=ticksInfo.maxTextWidth;if(pvc.debug>=5){this._log("calculateNumberHTicks RESULT error="+(ticksInfo.excessLength>=0?"+":"-")+(ticksInfo.error*100).toFixed(0)+"% count="+ticksInfo.ticks.length+" step="+ticksInfo.ticks.step)}}if(doLog){this._log("calculateNumberHTicks END")}},_calcNumberHDesiredTickCount:function(spacing){var layoutInfo=this._layoutInfo;var domainTextLength=this.scale.domain().map(function(tick){tick=+tick.toFixed(2);var text=this.scale.tickFormat(tick);return pv.Text.measure(text,this.font).width},this);var avgTextLength=Math.max((domainTextLength[1]+domainTextLength[0])/2,layoutInfo.textHeight);var clientLength=layoutInfo.clientSize[this.anchorLength()];return Math.max(1,~~(clientLength/(avgTextLength+spacing)))},_calcNumberHLength:function(ticksInfo,spacing){var ticksText=ticksInfo.ticksText;var maxTextWidth=def.query(ticksText).select(function(text){return pv.Text.measure(text,this.font).width},this).max();return Math.max(maxTextWidth,(ticksText.length-1)*(maxTextWidth+spacing))},_createCore:function(){if(this.scale.isNull){return}var clientSize=this._layoutInfo.clientSize;var paddings=this._layoutInfo.paddings;var begin_a=this.anchorOrtho();var end_a=this.anchorOpposite(begin_a);var size_a=this.anchorOrthoLength(begin_a);var rMin=this.ruleCrossesMargin?-paddings[begin_a]:0;var rMax=clientSize[size_a]+(this.ruleCrossesMargin?paddings[end_a]:0);var rSize=rMax-rMin;var ruleParentPanel=this.pvPanel;this._rSize=rSize;var rootScene=this._getRootScene();this.pvRule=new pvc.visual.Rule(this,this.pvPanel,{extensionId:'rule'}).lock('data',[rootScene]).override('defaultColor',def.fun.constant("#666666")).lock(this.anchorOpposite(),0).lock(begin_a,rMin).lock(size_a,rSize).pvMark.zOrder(30).strokeDasharray(null).lineCap('square');if(this.isDiscrete){if(this.useCompositeAxis){this.renderCompositeOrdinalAxis()}else{this.renderOrdinalAxis()}}else{this.renderLinearAxis()}},_getExtensionId:function(){return''},_getRootScene:function(){if(!this._rootScene){var rootScene=this._rootScene=new pvc.visual.CartesianAxisRootScene(null,{panel:this,group:this._getRootData()});var layoutInfo=this._layoutInfo;var ticksText=layoutInfo.ticksText;if(this.isDiscrete){if(this.useCompositeAxis){this._buildCompositeScene(rootScene)}else{layoutInfo.ticks.forEach(function(tickData,index){new pvc.visual.CartesianAxisTickScene(rootScene,{group:tickData,tick:tickData.value,tickRaw:tickData.rawValue,tickLabel:ticksText[index]})})}}else{layoutInfo.ticks.forEach(function(majorTick,index){new pvc.visual.CartesianAxisTickScene(rootScene,{tick:majorTick,tickRaw:majorTick,tickLabel:ticksText[index]})},this)}}return this._rootScene},_buildCompositeScene:function(rootScene){var isV1Compat=this.compatVersion()<=1;rootScene.vars.tick=new pvc.visual.ValueLabelVar('',"");recursive(rootScene);function recursive(scene){var data=scene.group;if(isV1Compat){var tickVar=scene.vars.tick;scene.nodeValue=scene.value=tickVar.rawValue;scene.nodeLabel=scene.label=tickVar.label}if(data.childCount()){data.children().each(function(childData){var childScene=new pvc.visual.CartesianAxisTickScene(scene,{group:childData,tick:childData.value,tickRaw:childData.rawValue,tickLabel:childData.label});recursive(childScene)})}}},_getRootData:function(){var chart=this.chart;var data=chart.data;if(this.isDiscrete&&this.useCompositeAxis){var orientation=this.anchor;var reverse=orientation=='bottom'||orientation=='left';data=chart.visualRoles(this.roleName).select(data,{visible:true,reverse:reverse})}return data},_getOrthoScale:function(){var orthoType=this.axis.type==='base'?'ortho':'base';return this.chart.axes[orthoType].scale},_getOrthoAxis:function(){var orthoType=this.axis.type==='base'?'ortho':'base';return this.chart.axes[orthoType]},renderOrdinalAxis:function(){var myself=this,scale=this.scale,hiddenLabelText=this.hiddenLabelText,anchorOpposite=this.anchorOpposite(),anchorLength=this.anchorLength(),anchorOrtho=this.anchorOrtho(),anchorOrthoLength=this.anchorOrthoLength(),layoutInfo=this._layoutInfo,pvRule=this.pvRule,ticks=layoutInfo.ticks,data=layoutInfo.data,itemCount=layoutInfo.ticks.length,rootScene=this._getRootScene(),includeModulo=this._tickIncludeModulo,isV1Compat=this.compatVersion()<=1;rootScene.vars.tickIncludeModulo=includeModulo;rootScene.vars.hiddenLabelText=hiddenLabelText;var wrapper;if(isV1Compat){var DataElement=function(tickVar){this.value=this.absValue=tickVar.rawValue;this.nodeName=''+(this.value||'');this.path=this.nodeName?[this.nodeName]:[];this.label=this.absLabel=tickVar.label};DataElement.prototype.toString=function(){return''+this.value};wrapper=function(v1f){return function(tickScene){var markWrapped=Object.create(this);markWrapped.index=this.parent.index;return v1f.call(markWrapped,new DataElement(tickScene.vars.tick))}}}var pvTicksPanel=new pvc.visual.Panel(this,this.pvPanel,{extensionId:'ticksPanel'}).lock('data',rootScene.childNodes).localProperty('hidden').lockMark('hidden',function(){return(this.index%includeModulo)!==0}).lock(anchorOpposite,0).lockMark(anchorOrtho,function(tickScene){return scale(tickScene.vars.tick.value)}).lock('strokeDasharray',null).lock('strokeStyle',null).lock('fillStyle',null).lock('lineWidth',0).pvMark.zOrder(20);if(isV1Compat||this.showTicks){var pvTicks=this.pvTicks=new pvc.visual.Rule(this,pvTicksPanel,{extensionId:'ticks',wrapper:wrapper}).lock('data').intercept('visible',function(){return!this.pvMark.parent.hidden()&&this.delegateExtension(true)}).optional('lineWidth',1).lock(anchorOpposite,0).lock(anchorOrtho,0).lock(anchorLength,null).optional(anchorOrthoLength,this.tickLength*2/3).override('defaultColor',function(type){if(isV1Compat){return pv.Color.names.transparent}return pvRule.scene?pvRule.scene[0].strokeStyle:"#666666"}).pvMark}var baseline;var align;switch(this.anchor){case'top':align='center';baseline='bottom';break;case'bottom':align='center';baseline='top';break;case'left':align='right';baseline='middle';break;case'right':align='left';baseline='middle';break}var font=this.font;var maxTextWidth=this._layoutInfo.maxTextWidth;if(!isFinite(maxTextWidth)){maxTextWidth=0}this.pvLabel=new pvc.visual.Label(this,pvTicksPanel,{extensionId:'label',noClick:false,noDoubleClick:false,noSelect:false,noTooltip:false,noHover:false,wrapper:wrapper,tooltipArgs:{buildTooltip:function(context){return context.scene.vars.tick.label},isLazy:false,options:{gravity:this._calcTipsyGravity()}}}).intercept('visible',function(tickScene){return!this.pvMark.parent.hidden()?this.delegateExtension(true):!!tickScene.vars.hiddenLabelText}).intercept('text',function(tickScene){var text;if(this.pvMark.parent.hidden()){text=tickScene.vars.hiddenLabelText}else{text=this.delegateExtension();if(text===undefined){text=tickScene.vars.tick.label}if(maxTextWidth){text=pvc.text.trimToWidthB(maxTextWidth,text,font,"..",false)}}return text}).pvMark.zOrder(40).lock(anchorOpposite,this.tickLength).lock(anchorOrtho,0).font(font).textStyle("#666666").textAlign(align).textBaseline(baseline);this._debugTicksPanel(pvTicksPanel)},_debugTicksPanel:function(pvTicksPanel){if(pvc.debug>=16){var corners=this._layoutInfo.labelBBox.source.points();if(corners.length>1){corners=corners.concat(corners[0])}pvTicksPanel.add(pv.Panel)[this.anchorOpposite()](this.tickLength)[this.anchorOrtho()](0)[this.anchorLength()](0)[this.anchorOrthoLength()](0).fillStyle(null).strokeStyle(null).lineWidth(0).add(pv.Line).visible(function(){var gp=this.parent.parent;return!gp.hidden||!gp.hidden()}).data(corners).left(function(p){return p.x}).top(function(p){return p.y}).strokeStyle('red').lineWidth(0.5).strokeDasharray('-')}},renderLinearAxis:function(){var scale=this.scale,orthoAxis=this._getOrthoAxis(),orthoScale=orthoAxis.scale,pvRule=this.pvRule,anchorOpposite=this.anchorOpposite(),anchorLength=this.anchorLength(),anchorOrtho=this.anchorOrtho(),anchorOrthoLength=this.anchorOrthoLength(),rootScene=this._getRootScene();var wrapper;if(this.compatVersion()<=1){wrapper=function(v1f){return function(tickScene){var markWrapped=Object.create(this);markWrapped.index=this.parent.index;return v1f.call(markWrapped,tickScene.vars.tick.rawValue)}}}var pvTicksPanel=new pvc.visual.Panel(this,this.pvPanel,{extensionId:'ticksPanel'}).lock('data',rootScene.childNodes).lock(anchorOpposite,0).lockMark(anchorOrtho,function(tickScene){return scale(tickScene.vars.tick.value)}).lock('strokeStyle',null).lock('fillStyle',null).lock('lineWidth',0).pvMark.zOrder(20);if(this.showTicks){var pvTicks=this.pvTicks=new pvc.visual.Rule(this,pvTicksPanel,{extensionId:'ticks',wrapper:wrapper}).lock('data').override('defaultColor',function(){return pvRule.scene?pvRule.scene[0].strokeStyle:"#666666"}).lock(anchorOpposite,0).lock(anchorOrtho,0).lock(anchorLength,null).optional(anchorOrthoLength,this.tickLength).pvMark;if(this.showMinorTicks){var layoutInfo=this._layoutInfo;var ticks=layoutInfo.ticks;var tickCount=ticks.length;var minorTickOffset=tickCount>1?Math.abs(scale(ticks[1])-scale(ticks[0]))/2:0;this.pvMinorTicks=new pvc.visual.Rule(this,this.pvTicks,{extensionId:'minorTicks',wrapper:wrapper}).lock('data').intercept('visible',function(){var visible=(this.index<tickCount-1)&&(!pvTicks.scene||pvTicks.scene[0].visible);return visible&&this.delegateExtension(true)}).override('defaultColor',function(){return pvTicks.scene?pvTicks.scene[0].strokeStyle:pv.Color.names.d}).lock(anchorOpposite,0).lock(anchorLength,null).optional(anchorOrthoLength,this.tickLength/2).lockMark(anchorOrtho,minorTickOffset).pvMark}}this.renderLinearAxisLabel(pvTicksPanel,wrapper);this._debugTicksPanel(pvTicksPanel)},renderLinearAxisLabel:function(pvTicksPanel,wrapper){var pvTicks=this.pvTicks;var anchorOpposite=this.anchorOpposite();var anchorOrtho=this.anchorOrtho();var scale=this.scale;var font=this.font;posFixoY="";if(this.chart.options.posFixoY){posFixoY=this.chart.options.posFixoY}var maxTextWidth=this._layoutInfo.maxTextWidth;if(!isFinite(maxTextWidth)){maxTextWidth=0}var label=this.pvLabel=new pvc.visual.Label(this,pvTicksPanel,{extensionId:'label',wrapper:wrapper}).lock('data').pvMark.lock(anchorOpposite,this.tickLength).lock(anchorOrtho,0).zOrder(40).text(function(tickScene){var text=tickScene.vars.tick.label+posFixoY;if(maxTextWidth){text=pvc.text.trimToWidthB(maxTextWidth,text,font,'..',false)}return text}).font(this.font).textStyle("#666666");var rootPanel=this.pvPanel.root;if(this.isAnchorTopOrBottom()){label.textBaseline(anchorOpposite).textAlign(function(tickScene){var absLeft;if(this.index===0){absLeft=label.toScreenTransform().transformHPosition(label.left());if(absLeft<=0){return'left'}}else if(this.index===tickScene.parent.childNodes.length-1){absLeft=label.toScreenTransform().transformHPosition(label.left());if(absLeft>=rootPanel.width()){return'right'}}return'center'})}else{label.textAlign(anchorOpposite).textBaseline(function(tickScene){var absTop;if(this.index===0){absTop=label.toScreenTransform().transformVPosition(label.top());if(absTop>=rootPanel.height()){return'bottom'}}else if(this.index===tickScene.parent.childNodes.length-1){absTop=label.toScreenTransform().transformVPosition(label.top());if(absTop<=0){return'top'}}return'middle'})}},_onV1Click:function(context,handler){if(this.isDiscrete&&this.useCompositeAxis){handler.call(context.pvMark,context.scene,context.event)}},_onV1DoubleClick:function(context,handler){if(this.isDiscrete&&this.useCompositeAxis){handler.call(context.pvMark,context.scene,context.event)}},_getSelectableMarks:function(){if(this.isDiscrete&&this.isVisible&&this.pvLabel){return[this.pvLabel]}},renderCompositeOrdinalAxis:function(){var myself=this,isTopOrBottom=this.isAnchorTopOrBottom(),axisDirection=isTopOrBottom?'h':'v',diagDepthCutoff=2,vertDepthCutoff=2,font=this.font;var diagMargin=pv.Text.fontHeight(font)/2;var layout=this._pvLayout=this.getLayoutSingleCluster();layout.node.def("fitInfo",null).height(function(tickScene,e,f){var fitInfo=pvc.text.getFitInfo(tickScene.dx,tickScene.dy,tickScene.vars.tick.label,font,diagMargin);if(!fitInfo.h){if(axisDirection==='v'&&fitInfo.v){vertDepthCutoff=Math.min(diagDepthCutoff,tickScene.depth)}else{diagDepthCutoff=Math.min(diagDepthCutoff,tickScene.depth)}}this.fitInfo(fitInfo);return tickScene.dy});layout.node.add(pv.Bar).fillStyle('rgba(127,127,127,.001)').strokeStyle(function(tickScene){if(tickScene.maxDepth===1||!tickScene.maxDepth){return null}return"rgba(127,127,127,0.3)"}).lineWidth(function(tickScene){if(tickScene.maxDepth===1||!tickScene.maxDepth){return 0}return 0.5}).text(function(tickScene){return tickScene.vars.tick.label});var H_CUTOFF_ANG=0.30,V_CUTOFF_ANG=1.27;var align=isTopOrBottom?"center":(this.anchor=="left")?"right":"left";var wrapper;if(this.compatVersion()<=1){wrapper=function(v1f){return function(tickScene){return v1f.call(this,tickScene)}}}this.pvLabel=new pvc.visual.Label(this,layout.label,{extensionId:'label',noClick:false,noDoubleClick:false,noSelect:false,noTooltip:false,noHover:false,wrapper:wrapper,tooltipArgs:{isLazy:false,buildTooltip:function(context){return context.scene.vars.tick.label},options:{gravity:this._calcTipsyGravity(),offset:diagMargin*2}}}).pvMark.def('lblDirection','h').textAngle(function(tickScene){if(tickScene.depth>=vertDepthCutoff&&tickScene.depth<diagDepthCutoff){this.lblDirection('v');return-Math.PI/2}if(tickScene.depth>=diagDepthCutoff){var tan=tickScene.dy/tickScene.dx;var angle=Math.atan(tan);if(angle>V_CUTOFF_ANG){this.lblDirection('v');return-Math.PI/2}if(angle>H_CUTOFF_ANG){this.lblDirection('d');return-angle}}this.lblDirection('h');return 0}).textMargin(1).textAlign(function(tickScene){return(axisDirection!='v'||tickScene.depth>=vertDepthCutoff||tickScene.depth>=diagDepthCutoff)?'center':align}).left(function(tickScene){return(axisDirection!='v'||tickScene.depth>=vertDepthCutoff||tickScene.depth>=diagDepthCutoff)?tickScene.x+tickScene.dx/2:((align=='right')?tickScene.x+tickScene.dx:tickScene.x)}).font(font).textStyle("#666666").text(function(tickScene){var fitInfo=this.fitInfo();var label=tickScene.vars.tick.label;switch(this.lblDirection()){case'h':if(!fitInfo.h){return pvc.text.trimToWidth(tickScene.dx,label,font,'..')}break;case'v':if(!fitInfo.v){return pvc.text.trimToWidth(tickScene.dy,label,font,'..')}break;case'd':if(!fitInfo.d){var diagonalLength=Math.sqrt(tickScene.dy*tickScene.dy+tickScene.dx*tickScene.dx);return pvc.text.trimToWidth(diagonalLength-diagMargin,label,font,'..')}break}return label})},getLayoutSingleCluster:function(){var rootScene=this._getRootScene(),orientation=this.anchor,maxDepth=rootScene.group.treeHeight,depthLength=this._layoutInfo.axisSize;maxDepth++;var baseDisplacement=depthLength/maxDepth,margin=maxDepth>2?((1/12)*depthLength):0;baseDisplacement-=margin;var scaleFactor=maxDepth/(maxDepth-1),orthoLength=pvc.BasePanel.orthogonalLength[orientation];var displacement=(orthoLength=='width')?(orientation==='left'?[-baseDisplacement,0]:[baseDisplacement,0]):(orientation==='top'?[0,-baseDisplacement]:[0,baseDisplacement]);this.pvRule.sign.override('defaultColor',def.fun.constant(null)).override('defaultStrokeWidth',def.fun.constant(0));var panel=this.pvRule.add(pv.Panel)[orthoLength](depthLength).strokeStyle(null).lineWidth(0).add(pv.Panel)[orthoLength](depthLength*scaleFactor).strokeStyle(null).lineWidth(0);panel.transform(pv.Transform.identity.translate(displacement[0],displacement[1]));return panel.add(pv.Layout.Cluster.Fill).nodes(rootScene.nodes()).orient(orientation)},_calcTipsyGravity:function(){switch(this.anchor){case'bottom':return's';case'top':return'n';case'left':return'w';case'right':return'e'}return's'}});