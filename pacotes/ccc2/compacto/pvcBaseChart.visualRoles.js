pvc.BaseChart.add({_visualRoles:null,_visualRoleList:null,_serRole:null,_dataPartRole:null,_measureVisualRoles:null,_constructVisualRoles:function(){var parent=this.parent;if(parent){this._visualRoles=parent._visualRoles;this._visualRoleList=parent._visualRoleList;this._measureVisualRoles=parent._measureVisualRoles;if(parent._multiChartRole){this._multiChartRole=parent._multiChartRole}if(parent._serRole){this._serRole=parent._serRole}if(parent._colorRole){this._colorRole=parent._colorRole}if(parent._dataPartRole){this._dataPartRole=parent._dataPartRole}}else{this._visualRoles={};this._visualRoleList=[];this._measureVisualRoles=[]}},_hasDataPartRole:function(){return false},_getSeriesRoleSpec:function(){return null},_getColorRoleSpec:function(){return null},_addVisualRole:function(name,keyArgs){keyArgs=def.set(keyArgs,'index',this._visualRoleList.length);var visualRole=new pvc.visual.Role(name,keyArgs);this._visualRoleList.push(visualRole);this._visualRoles[name]=visualRole;if(visualRole.isMeasure){this._measureVisualRoles.push(visualRole)}return visualRole},_initVisualRoles:function(){this._multiChartRole=this._addVisualRole('multiChart',{defaultDimension:'multiChart*',requireIsDiscrete:true});if(this._hasDataPartRole()){this._dataPartRole=this._addVisualRole('dataPart',{defaultDimension:'dataPart',requireSingleDimension:true,requireIsDiscrete:true,dimensionDefaults:{isHidden:true,comparer:def.compare}})}var serRoleSpec=this._getSeriesRoleSpec();if(serRoleSpec){this._serRole=this._addVisualRole('series',serRoleSpec)}var colorRoleSpec=this._getColorRoleSpec();if(colorRoleSpec){this._colorRole=this._addVisualRole('color',colorRoleSpec)}},_bindVisualRolesPreI:function(){def.eachOwn(this._visualRoles,function(role){role.setIsReversed(false)});var sourcedRoles=[];var options=this.options;var roleOptions=options.visualRoles;this._visualRoleList.forEach(function(visualRole){var name=visualRole.name;var roleSpec=options[name+'Role'];if(roleSpec!==undefined){if(!roleOptions){roleOptions=options.visualRoles={}}if(roleOptions[name]===undefined){roleOptions[name]=roleSpec}}});var dimsBoundToSingleRole;if(roleOptions){dimsBoundToSingleRole={};var rolesWithOptions=def.query(def.keys(roleOptions)).select(function(name){return this._visualRoles[name]||def.fail.operationInvalid("Role '{0}' is not supported by the chart type.",[name])},this).array();rolesWithOptions.sort(function(a,b){return a.index-b.index});rolesWithOptions.forEach(function(visualRole){var name=visualRole.name;var roleSpec=roleOptions[name];var groupingSpec,sourceRoleName;if(def.object.is(roleSpec)){if(def.nullyTo(roleSpec.isReversed,false)){visualRole.setIsReversed(true)}sourceRoleName=roleSpec.from;if(sourceRoleName&&(sourceRoleName!==name)){var sourceRole=this._visualRoles[sourceRoleName]||def.fail.operationInvalid("Source role '{0}' is not supported by the chart type.",[sourceRoleName]);visualRole.setSourceRole(sourceRole);sourcedRoles.push(visualRole)}else{groupingSpec=roleSpec.dimensions}}else{groupingSpec=roleSpec}if(groupingSpec!==undefined){var grouping=pvc.data.GroupingSpec.parse(groupingSpec);visualRole.preBind(grouping);grouping.dimensions().each(function(groupDimSpec){if(def.hasOwn(dimsBoundToSingleRole,groupDimSpec.name)){delete dimsBoundToSingleRole[groupDimSpec.name]}else{dimsBoundToSingleRole[groupDimSpec.name]=visualRole}})}},this)}this._sourcedRoles=sourcedRoles;this._dimsBoundToSingleRole=dimsBoundToSingleRole},_bindVisualRolesPreII:function(){var dimsBoundToSingleRole=this._dimsBoundToSingleRole;if(dimsBoundToSingleRole){delete this._dimsBoundToSingleRole;def.eachOwn(dimsBoundToSingleRole,this._setRoleBoundDimensionDefaults,this)}var sourcedRoles=this._sourcedRoles;delete this._sourcedRoles;def.query(this._visualRoleList).where(function(role){return role.defaultSourceRoleName&&!role.sourceRole&&!role.isPreBound()}).each(function(role){var sourceRole=this._visualRoles[role.defaultSourceRoleName];if(sourceRole){role.setSourceRole(sourceRole);sourcedRoles.push(role)}},this);sourcedRoles.forEach(function(role){var sourceRole=role.sourceRole;if(sourceRole.isReversed){role.setIsReversed(!role.isReversed)}if(!role.defaultDimensionName&&sourceRole.isPreBound()){role.preBind(sourceRole.preBoundGrouping())}})},_setRoleBoundDimensionDefaults:function(role,dimName){this._complexTypeProj.setDimDefaults(dimName,role.dimensionDefaults)},_bindVisualRolesPostI:function(){var complexTypeProj=this._complexTypeProj;var boundDimTypes={};var unboundSourcedRoles=[];def.query(this._visualRoleList).where(function(role){return role.isPreBound()}).each(markPreBoundRoleDims,this);def.query(this._visualRoleList).where(function(role){return!role.isPreBound()}).each(autoBindUnboundRole,this);unboundSourcedRoles.forEach(tryPreBindSourcedRole,this);def.query(def.ownKeys(boundDimTypes)).where(function(dimName){return boundDimTypes[dimName].length===1}).each(function(dimName){var singleRole=boundDimTypes[dimName][0];this._setRoleBoundDimensionDefaults(singleRole,dimName)},this);function markDimBoundTo(dimName,role){def.array.lazy(boundDimTypes,dimName).push(role)}function dimIsDefined(dimName){return complexTypeProj.hasDim(dimName)}function preBindRoleTo(role,dimNames){if(def.array.is(dimNames)){dimNames.forEach(function(dimName){markDimBoundTo(dimName,role)})}else{markDimBoundTo(dimNames,role)}role.setSourceRole(null);role.preBind(pvc.data.GroupingSpec.parse(dimNames))}function preBindRoleToGroupDims(role,groupDimNames){if(groupDimNames.length){if(role.requireSingleDimension){preBindRoleTo(role,groupDimNames[0])}else{preBindRoleTo(role,groupDimNames)}}}function preBindRoleToNewDim(role,dimName){complexTypeProj.setDim(dimName,{isHidden:true});preBindRoleTo(role,dimName)}function roleIsUnbound(role){if(role.isRequired){throw def.error.operationInvalid("Chart type requires unassigned role '{0}'.",[role.name])}role.bind(null);role.setSourceRole(null)}function markPreBoundRoleDims(role){role.preBoundGrouping().dimensionNames().forEach(markDimBoundTo)}function autoBindUnboundRole(role){var name=role.name;var dimName=role.defaultDimensionName;if(!dimName){if(role.sourceRole){unboundSourcedRoles.push(role)}else{roleIsUnbound(role)}return}var match=dimName.match(/^(.*?)(\*)?$/)||def.fail.argumentInvalid('defaultDimensionName');var defaultName=match[1];var greedy=match[2];if(greedy){var groupDimNames=complexTypeProj.groupDimensionsNames(defaultName);if(groupDimNames){preBindRoleToGroupDims(role,groupDimNames);return}}else if(dimIsDefined(defaultName)){preBindRoleTo(role,defaultName);return}if(role.autoCreateDimension){preBindRoleToNewDim(role,defaultName);return}if(role.sourceRole){unboundSourcedRoles.push(role)}else{roleIsUnbound(role)}}function tryPreBindSourcedRole(role){var sourceRole=role.sourceRole;if(sourceRole.isPreBound()){role.preBind(sourceRole.preBoundGrouping())}else{roleIsUnbound(role)}}},_bindVisualRolesPostII:function(complexType){def.query(this._visualRoleList).where(function(role){return role.isPreBound()}).each(commitRolePreBinding,this);function commitRolePreBinding(role){role.postBind(complexType)}},_logVisualRoles:function(){var out=["VISUAL ROLES MAP SUMMARY",pvc.logSeparator,"  VisualRole         <-- Dimensions",pvc.logSeparator];def.eachOwn(this._visualRoles,function(role,name){out.push("  "+name+def.array.create(18-name.length," ").join("")+(role.grouping?(" <-- "+role.grouping):''))});this._log(out.join("\n"))},visualRoles:function(roleName,keyArgs){if(roleName==null){return def.own(this._visualRoles)}var role=def.getOwn(this._visualRoles,roleName)||null;if(!role&&def.get(keyArgs,'assertExists',true)){throw def.error.argumentInvalid('roleName',"Undefined role name '{0}'.",[roleName])}return role},measureVisualRoles:function(){return this._measureVisualRoles},measureDimensionsNames:function(){return def.query(this._measureVisualRoles).select(function(visualRole){return visualRole.firstDimensionName()}).where(def.notNully).array()},_isRoleAssigned:function(roleName){return!!this._visualRoles[roleName].grouping},_getDataPartDimName:function(){var role=this._dataPartRole;if(role){if(role.isBound()){return role.firstDimensionName()}var preGrouping=role.preBoundGrouping();if(preGrouping){return preGrouping.firstDimensionName()}return role.defaultDimensionName}}});